<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROBO Teacher SD - Asisten Belajar AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --primary: #f97316; 
            --primary-dark: #ea580c; 
            --primary-light: #fff7ed; 
            --secondary: #10b981; 
            --secondary-dark: #059669; 
            --bg-main: #f8fafc; 
            --bg-white: #ffffff; 
            --text-main: #1e293b; 
            --text-muted: #64748b; 
            --border-color: #e2e8f0; 
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            --radius-sm: 8px; 
            --radius-md: 12px; 
            --radius-lg: 16px; 
            --radius-full: 9999px; 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; height: 100vh; height: 100dvh; overflow: hidden; touch-action: manipulation; color: var(--text-main); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .app-container { display: flex; height: 100vh; height: 100dvh; position: relative; }
        
        /* Chat Sidebar Styles */
        .chat-sidebar { width: 380px; min-width: 380px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(226, 232, 240, 0.8); display: flex; flex-direction: column; box-shadow: var(--shadow-lg); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); position: relative; z-index: 100; }
        .chat-sidebar.closed { transform: translateX(-100%); margin-right: -380px; }
        .chat-header { padding: 20px; background: transparent; border-bottom: 1px solid rgba(226, 232, 240, 0.5); display: flex; flex-direction: column; gap: 12px; }
        .header-cards { display: flex; gap: 12px; align-items: stretch; }
        .title-card { flex: 1; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: var(--radius-md); padding: 14px; display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 20px rgba(249, 115, 22, 0.25); position: relative; overflow: hidden; }
        .title-icon { width: 42px; height: 42px; min-width: 42px; background: rgba(255,255,255,0.25); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 24px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        .title-text h2 { font-size: 15px; font-weight: 800; color: white; letter-spacing: 0.3px; text-transform: uppercase; }
        .title-text .subtitle { font-size: 10px; color: rgba(255,255,255,0.9); }
        .counter-card { flex: 1; background: var(--bg-white); border-radius: var(--radius-md); padding: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; }
        .counter-value { font-size: 18px; font-weight: 800; color: var(--primary); font-family: 'Courier New', monospace; }
        .api-status { display: flex; align-items: center; gap: 8px; font-size: 11px; padding: 8px 14px; border-radius: var(--radius-sm); margin-top: 8px; font-weight: 600; cursor: default; }
        .api-status.active { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .api-status.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; cursor: pointer; }
        .api-status.warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; cursor: pointer; }
        .btn-close-sidebar { position: absolute; top: 12px; right: 12px; width: 30px; height: 30px; border: 1px solid var(--border-color); background: var(--bg-white); color: var(--text-muted); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; z-index: 10; }
        .btn-close-sidebar:hover { background: #ef4444; color: white; border-color: #ef4444; transform: rotate(90deg); }
        .chat-messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: var(--bg-main); }
        .message { max-width: 85%; padding: 12px 16px; border-radius: var(--radius-lg); font-size: 14px; line-height: 1.6; animation: messageSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1); position: relative; word-wrap: break-word; overflow-wrap: break-word; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .message.bot { align-self: flex-start; background: var(--bg-white); color: var(--text-main); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }
        .message.user { align-self: flex-end; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-bottom-right-radius: 4px; }
        .message.error { background: #fff5f5; color: #c53030; font-size: 12px; border: 1px solid #fed7d7; }
        .typing { display: flex; gap: 6px; padding: 14px 20px; background: var(--bg-white); border-radius: var(--radius-lg); align-self: flex-start; border: 1px solid var(--border-color); }
        .typing span { width: 8px; height: 8px; background: var(--primary); border-radius: var(--radius-full); animation: typing 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-8px); opacity: 1; } }
        .chat-input-container { padding: 16px; background: var(--bg-white); border-top: 1px solid rgba(226, 232, 240, 0.5); }
        .upload-preview { display: none; margin-bottom: 10px; padding: 10px; background: var(--bg-main); border-radius: var(--radius-sm); border: 1px solid var(--border-color); position: relative; }
        .upload-preview.active { display: block; }
        .upload-preview img { max-height: 80px; max-width: 100%; border-radius: var(--radius-sm); }
        .btn-remove-upload { position: absolute; top: 4px; right: 4px; width: 22px; height: 22px; border: none; background: #ef4444; color: white; border-radius: var(--radius-full); cursor: pointer; font-size: 12px; }
        .input-toolbar { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-tool { width: 40px; height: 40px; border: 1px solid var(--border-color); background: var(--bg-main); border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s; position: relative; overflow: hidden; color: var(--text-muted); }
        .btn-tool:hover { border-color: var(--primary); color: var(--primary); }
        .btn-tool input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .input-box { display: flex; gap: 8px; align-items: flex-end; background: var(--bg-main); border-radius: var(--radius-md); padding: 6px; border: 2px solid var(--border-color); margin-bottom: 10px; }
        .input-box:focus-within { border-color: var(--primary); background: var(--bg-white); }
        #messageInput { flex: 1; border: none; background: transparent; padding: 10px 12px; outline: none; font-size: 14px; resize: none; max-height: 100px; min-height: 40px; font-family: inherit; width: 100%; }
        .btn-icon { width: 36px; height: 36px; border: none; background: transparent; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--text-muted); }
        .btn-icon.voice { color: #ef4444; }
        .btn-icon.voice.recording { animation: pulse 1s infinite; background: #fef2f2; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .btn-send { width: 42px; height: 42px; border: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: var(--radius-sm); cursor: pointer; font-size: 18px; }
        .btn-open-chat { position: fixed; left: 20px; bottom: 20px; width: 60px; height: 60px; background: var(--bg-white); color: var(--primary); border: 2px solid var(--primary); border-radius: var(--radius-full); cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 28px; z-index: 99; animation: robotFloat 3s ease-in-out infinite; }
        @keyframes robotFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .btn-open-chat.show { display: flex; }
        .workspace { flex: 1; display: flex; flex-direction: column; background: var(--bg-main); min-width: 0; overflow: hidden; }
        
        /* === TOOLBAR PERBAIKAN === */
        .toolbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 20px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(20px); 
            border-bottom: 1px solid rgba(226, 232, 240, 0.8); 
            gap: 12px; 
            flex-wrap: wrap; 
        }
        
        .toolbar-left { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            flex-wrap: wrap; 
            flex: 1; 
            min-width: 0; 
        }
        
        /* === SELECT DROPDOWN PERBAIKAN === */
        .select-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .grade-select, .subject-select-new {
            padding: 10px 36px 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            background: var(--bg-white);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            color: var(--text-main);
            min-width: 120px;
            transition: all 0.2s;
        }
        
        .grade-select {
            min-width: 100px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .grade-select:hover, .subject-select-new:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .grade-select:focus, .subject-select-new:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }
        
        .subject-select-new {
            min-width: 200px;
        }
        
        .subject-select-new:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }
        
        .mode-toggle { display: flex; background: var(--bg-main); border-radius: var(--radius-sm); padding: 4px; gap: 4px; border: 1px solid var(--border-color); }
        .mode-btn { padding: 10px 18px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--text-muted); }
        .mode-btn.active { background: var(--bg-white); color: var(--primary); box-shadow: var(--shadow-sm); }
        .toolbar-actions { display: flex; gap: 10px; }
        .btn-ask { padding: 12px 22px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .btn-save { padding: 12px 20px; background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%); color: white; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; }
        .content-area { flex: 1; position: relative; overflow: hidden; display: flex; width: 100%; background: var(--bg-main); }

        /* Layout */
        .text-mode, .canvas-mode {
            flex: 1; display: none; width: 100%; height: 100%; overflow: hidden;
            gap: 2px; background: var(--border-color);
            flex-direction: row;
        }
        .text-mode.active { display: flex; }
        .canvas-mode.active { display: flex; }

        .question-section, .answer-section,
        .canvas-question-section, .canvas-answer-section {
            flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-white);
        }

        .question-header, .answer-header,
        .canvas-question-header, .canvas-answer-header {
            padding: 12px 20px; font-weight: 700; font-size: 13px;
            display: flex; align-items: center; justify-content: space-between;
            text-transform: uppercase; letter-spacing: 0.5px; box-shadow: var(--shadow-sm);
            position: relative; z-index: 2; min-height: 50px;
        }

        .question-header, .canvas-question-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;
        }
        .answer-header, .canvas-answer-header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%); color: white;
        }

        .question-editor-container, .answer-editor-container,
        .canvas-container, .canvas-answer-container {
            flex: 1; overflow: hidden; position: relative;
        }

        #questionEditor, #answerEditor {
            width: 100%; height: 100%; border: none; outline: none;
            padding: 20px; font-size: 15px; line-height: 1.7;
            resize: none; font-family: inherit;
        }
        #questionEditor { background: var(--bg-white); }
        #answerEditor { background: #f0fdf4; }
        
        .btn-clear-text {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 14px; border-radius: 6px; cursor: pointer;
            font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px;
            transition: all 0.2s;
        }
        .btn-clear-text:hover { background: rgba(255,255,255,0.3); }
        .counter-footer {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: #94a3b8;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Canvas */
        .canvas-container { border: none; margin: 0; background: #fffbf5; position: relative; }
        #drawingCanvas { cursor: crosshair; background: transparent; width: 100%; height: 100%; touch-action: none; }
        
        /* === TOOLBAR DROPDOWN GAMBAR === */
        .canvas-toolbar {
            display: flex; 
            gap: 8px; 
            background: rgba(255, 255, 255, 0.98); 
            backdrop-filter: blur(10px);
            padding: 6px 10px; 
            border-radius: var(--radius-md); 
            border: 1px solid var(--border-color); 
            box-shadow: var(--shadow-md);
            align-items: center;
        }
        
        .tool-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .tool-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-white);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-main);
            transition: all 0.2s;
            min-width: 110px;
            justify-content: space-between;
        }
        
        .tool-dropdown-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .tool-dropdown-btn.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .tool-dropdown-btn .icon {
            font-size: 16px;
        }
        
        .tool-dropdown-btn .arrow {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        
        .tool-dropdown.open .tool-dropdown-btn .arrow {
            transform: rotate(180deg);
        }
        
        .tool-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: var(--bg-white);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .tool-dropdown.open .tool-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-color);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .dropdown-item.active {
            background: var(--primary);
            color: white;
        }
        
        .dropdown-item .item-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
        }
        
        .dropdown-divider {
            height: 2px;
            background: var(--border-color);
            margin: 4px 0;
        }
        
        .toolbar-utilities {
            display: flex;
            gap: 6px;
            padding-left: 8px;
            border-left: 2px solid var(--border-color);
            margin-left: 4px;
        }
        
        .tool-btn { 
            width: 36px; 
            height: 36px; 
            border: 2px solid var(--border-color); 
            background: var(--bg-white); 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
            color: var(--text-muted); 
            transition: all 0.2s;
            position: relative;
        }
        
        .tool-btn:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            transform: translateY(-2px);
        }
        
        .tool-btn.active { 
            border-color: var(--primary); 
            color: var(--primary); 
            background: var(--primary-light);
        }
        
        .color-picker-wrapper { 
            position: relative; 
            width: 36px; 
            height: 36px; 
            border-radius: var(--radius-md); 
            overflow: hidden; 
            border: 2px solid var(--border-color); 
        }
        
        .color-picker { 
            position: absolute; 
            top: -50%; 
            left: -50%; 
            width: 200%; 
            height: 200%; 
            cursor: pointer; 
            border: none; 
        }

        .canvas-answer-container { background: #f0fdf4; padding: 20px; overflow-y: auto; }
        #canvasAnswerArea { width: 100%; min-height: 100%; font-size: 15px; line-height: 1.7; font-family: inherit; white-space: pre-wrap; }

        /* Text Input Overlay */
        .text-input-overlay {
            position: absolute;
            background: white;
            border: 2px solid var(--primary);
            border-radius: var(--radius-md);
            padding: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
            min-width: 200px;
        }
        
        .text-input-overlay.active {
            display: block;
        }
        
        .text-input-overlay input {
            border: 1px solid var(--border-color);
            outline: none;
            font-size: 14px;
            font-family: inherit;
            padding: 8px;
            width: 100%;
            min-width: 150px;
            border-radius: var(--radius-sm);
        }
        
        .text-input-overlay input:focus {
            border-color: var(--primary);
        }
        
        .text-input-overlay .text-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        .text-input-overlay button {
            padding: 6px 16px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        
        .btn-text-ok {
            background: var(--primary);
            color: white;
        }
        
        .btn-text-cancel {
            background: var(--bg-main);
            color: var(--text-muted);
        }

        /* Modals */
        .camera-modal, .save-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(8px); padding: 20px; }
        .camera-modal.active, .save-modal.active { display: flex; }
        .camera-container { position: relative; width: 100%; max-width: 600px; max-height: 70vh; border: 3px solid var(--primary); border-radius: var(--radius-lg); overflow: hidden; }
        #cameraVideo { width: 100%; height: auto; display: block; }
        .camera-controls { display: flex; gap: 20px; margin-top: 24px; justify-content: center; }
        .btn-camera { width: 70px; height: 70px; border: 4px solid var(--primary); background: #ef4444; border-radius: var(--radius-full); cursor: pointer; }
        .btn-camera-cancel { padding: 12px 32px; background: transparent; color: var(--primary); border: 2px solid var(--primary); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; }
        .save-options { background: var(--bg-white); padding: 32px; border-radius: var(--radius-lg); max-width: 420px; width: 100%; border: 1px solid var(--border-color); }
        .save-options h3 { margin-bottom: 24px; text-align: center; }
        .save-btn-group { display: flex; flex-direction: column; gap: 14px; }
        .btn-save-option { padding: 16px 20px; border: 1px solid var(--border-color); background: var(--bg-white); border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; gap: 16px; transition: all 0.3s; }
        .btn-save-option:hover { border-color: var(--primary); transform: translateX(8px); }
        .btn-save-option .icon { font-size: 28px; }
        .btn-close-modal { margin-top: 20px; width: 100%; padding: 12px; background: var(--bg-main); border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 14px; }
        .toast { position: fixed; top: 20px; right: 20px; background: var(--bg-white); padding: 18px 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); display: none; align-items: center; gap: 14px; z-index: 3000; border-left: 5px solid var(--primary); min-width: 280px; }
        .toast.show { display: flex; }

        /* Responsive */
        @media (max-width: 768px) {
            .text-mode, .canvas-mode { flex-direction: column !important; }
            .chat-sidebar { width: 100%; min-width: 100%; position: fixed; }
            .header-cards { flex-direction: column; }
            .toolbar { padding: 10px; }
            .toolbar-left { gap: 8px; }
            .grade-select, .subject-select-new { font-size: 13px; min-width: 90px; }
            .subject-select-new { min-width: 150px; }
            .mode-toggle { width: 100%; }
            .canvas-toolbar { flex-wrap: wrap; }
            .tool-dropdown-btn { min-width: 90px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="chat-header">
                <button class="btn-close-sidebar" onclick="toggleChat()" title="Tutup Chat">√ó</button>
                <div class="header-cards">
                    <div class="title-card">
                        <div class="title-icon">ü§ñ</div>
                        <div class="title-text">
                            <h2>ROBO</h2>
                            <div class="subtitle">AI Teacher</div>
                        </div>
                    </div>
                    <div class="counter-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-size:9px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">JMH PERTANYAAN</span>
                            <span class="counter-value" id="counterValue">0</span>
                        </div>
                        <div style="height: 6px; background: var(--bg-main); border-radius: 9999px; overflow: hidden;">
                            <div id="counterFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), #fb923c);"></div>
                        </div>
                        <div class="counter-footer">
                            <span id="apiProvider">AI TEACHER</span>
                            <span id="remainingCount">Max 2000/Bln</span>
                        </div>
                    </div>
                </div>
                <div style="background: var(--bg-main); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 10px; text-align: center; color: var(--text-muted); font-weight: 600; margin-top: 8px;">
                    Wantu Update setiap Tgl 1
                </div>
                <div class="api-status warning" id="apiStatus">
                    <span>‚ö†Ô∏è</span>
                    <span>Memeriksa server...</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    üëã Halo! Saya ROBO AI Teacher untuk Kelas 1-12.<br><br>
                    üéØ Pilih Kelas dan Mata Pelajaran di toolbar atas.<br>
                    ‚Ä¢ SD Kelas 1-6<br>
                    ‚Ä¢ SMP Kelas 7-9<br>
                    ‚Ä¢ SMA/SMK Kelas 10-12
                </div>
            </div>

            <div class="chat-input-container">
                <div class="upload-preview" id="uploadPreview">
                    <img id="previewImage" src="" alt="Preview">
                    <button class="btn-remove-upload" onclick="removeUpload()" title="Hapus">√ó</button>
                </div>
                <div class="input-toolbar">
                    <button class="btn-tool" title="Upload Gambar">üìÅ<input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)"></button>
                    <button class="btn-tool" onclick="openCamera()" title="Foto Kamera">üì∑</button>
                </div>
                <div class="input-box">
                    <textarea id="messageInput" placeholder="Ketik pertanyaanmu..." rows="3" onkeypress="handleKeyPress(event)"></textarea>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="btn-icon voice" id="voiceBtn" onclick="toggleVoice()" title="Voice Input">üé§</button>
                    <button class="btn-send" onclick="sendMessage()" title="Kirim">‚û§</button>
                </div>
            </div>
        </aside>

        <button class="btn-open-chat" id="btnOpenChat" onclick="toggleChat()">ü§ñ</button>

        <main class="workspace" id="workspace">
            <div class="toolbar">
                <div class="toolbar-left">
                    <!-- Dropdown Kelas -->
                    <div class="select-wrapper">
                        <select class="grade-select" id="gradeSelect" onchange="changeGrade(this.value)">
                            <option value="" disabled selected>Pilih Kelas</option>
                            <optgroup label="SEKOLAH DASAR">
                                <option value="1">Kelas 1 SD</option>
                                <option value="2">Kelas 2 SD</option>
                                <option value="3">Kelas 3 SD</option>
                                <option value="4">Kelas 4 SD</option>
                                <option value="5">Kelas 5 SD</option>
                                <option value="6">Kelas 6 SD</option>
                            </optgroup>
                            <optgroup label="SEKOLAH MENENGAH PERTAMA">
                                <option value="7">Kelas 7 SMP</option>
                                <option value="8">Kelas 8 SMP</option>
                                <option value="9">Kelas 9 SMP</option>
                            </optgroup>
                            <optgroup label="SEKOLAH MENENGAH ATAS">
                                <option value="10">Kelas 10 SMA/SMK</option>
                                <option value="11">Kelas 11 SMA/SMK</option>
                                <option value="12">Kelas 12 SMA/SMK</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Dropdown Mata Pelajaran -->
                    <div class="select-wrapper">
                        <select class="subject-select-new" id="subjectSelect" onchange="changeSubject(this.value)" disabled>
                            <option value="" disabled selected>Pilih Mata Pelajaran</option>
                        </select>
                    </div>

                    <div class="mode-toggle">
                        <button class="mode-btn active" onclick="switchMode('text')">SOAL TEXT</button>
                        <button class="mode-btn" onclick="switchMode('canvas')">SOAL GAMBAR</button>
                    </div>
                </div>
                
                <div class="toolbar-actions">
                    <button class="btn-ask" onclick="askFromContent()"><span>MINTA JAWABAN</span></button>
                    <button class="btn-save" onclick="showSaveOptions()"><span>SIMPAN</span></button>
                </div>
            </div>

            <div class="content-area">
                <div class="text-mode active" id="textMode">
                    <div class="question-section">
                        <div class="question-header">
                            <span>‚ùì PERTANYAAN</span>
                            <button class="btn-clear-text" onclick="clearQuestionText()" title="Bersihkan">üóëÔ∏è Bersihkan</button>
                        </div>
                        <div class="question-editor-container">
                            <textarea id="questionEditor" placeholder="Tulis pertanyaan atau soalmu di sini..."></textarea>
                        </div>
                    </div>
                    <div class="answer-section">
                        <div class="answer-header">Jawaban AI</div>
                        <div class="answer-editor-container">
                            <textarea id="answerEditor" placeholder="Jawaban dari ROBO AI Teacher akan muncul di sini..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="canvas-mode" id="canvasMode">
                    <div class="canvas-question-section">
                        <div class="canvas-question-header">
                            <span>üé® Gambar Pertanyaan</span>
                            
                            <!-- Toolbar dengan Dropdown -->
                            <div class="canvas-toolbar">
                                <!-- Dropdown: Gambar -->
                                <div class="tool-dropdown" id="drawDropdown">
                                    <button class="tool-dropdown-btn" onclick="toggleDropdown('drawDropdown')">
                                        <span class="icon">‚úèÔ∏è</span>
                                        <span class="label" id="drawLabel">Pena</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div class="tool-dropdown-menu">
                                        <div class="dropdown-item active" onclick="selectTool('pen', 'Pena', '‚úèÔ∏è')">
                                            <span class="item-icon">‚úèÔ∏è</span>
                                            <span>Pena Bebas</span>
                                        </div>
                                        <div class="dropdown-item" onclick="selectTool('line', 'Garis', 'üìè')">
                                            <span class="item-icon">üìè</span>
                                            <span>Garis Lurus</span>
                                        </div>
                                        <div class="dropdown-item" onclick="selectTool('curve', 'Kurva', '„Ä∞Ô∏è')">
                                            <span class="item-icon">„Ä∞Ô∏è</span>
                                            <span>Kurva / Lengkung</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dropdown: Bentuk -->
                                <div class="tool-dropdown" id="shapeDropdown">
                                    <button class="tool-dropdown-btn" onclick="toggleDropdown('shapeDropdown')">
                                        <span class="icon">‚ñ≠</span>
                                        <span class="label" id="shapeLabel">Bentuk</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div class="tool-dropdown-menu">
                                        <div class="dropdown-item" onclick="selectTool('rect', 'Persegi Panjang', '‚ñ≠')">
                                            <span class="item-icon">‚ñ≠</span>
                                            <span>Persegi Panjang</span>
                                        </div>
                                        <div class="dropdown-item" onclick="selectTool('square', 'Persegi', '‚òê')">
                                            <span class="item-icon">‚òê</span>
                                            <span>Persegi</span>
                                        </div>
                                        <div class="dropdown-item" onclick="selectTool('circle', 'Lingkaran', '‚óã')">
                                            <span class="item-icon">‚óã</span>
                                            <span>Lingkaran</span>
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-item" onclick="selectTool('triangle', 'Segitiga Sama Sisi', '‚ñ≥')">
                                            <span class="item-icon">‚ñ≥</span>
                                            <span>Segitiga Sama Sisi</span>
                                        </div>
                                        <div class="dropdown-item" onclick="selectTool('triangle-right', 'Segitiga Siku', '‚óø')">
                                            <span class="item-icon">‚óø</span>
                                            <span>Segitiga Siku-Siku</span>
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <div class="dropdown-item" onclick="selectTool('arrow', 'Panah', '‚ûú')">
                                            <span class="item-icon">‚ûú</span>
                                            <span>Panah</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dropdown: Teks -->
                                <div class="tool-dropdown" id="textDropdown">
                                    <button class="tool-dropdown-btn" onclick="toggleDropdown('textDropdown')">
                                        <span class="icon" style="font-weight:800;">T</span>
                                        <span class="label">Teks</span>
                                        <span class="arrow">‚ñº</span>
                                    </button>
                                    <div class="tool-dropdown-menu">
                                        <div class="dropdown-item" onclick="selectTool('text', 'Teks', 'T')">
                                            <span class="item-icon" style="font-weight:800;">T</span>
                                            <span>Tambah Teks</span>
                                        </div>
                                        <div class="dropdown-item" onclick="selectTool('text-box', 'Kotak Teks', '‚ñ§')">
                                            <span class="item-icon">‚ñ§</span>
                                            <span>Kotak Teks</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Utility Buttons -->
                                <div class="toolbar-utilities">
                                    <button class="tool-btn" title="Penghapus" onclick="selectTool('eraser', 'Hapus', 'üßπ')">
                                        üßπ
                                    </button>
                                    <div class="color-picker-wrapper">
                                        <input type="color" class="color-picker" id="colorPicker" value="#f97316" onchange="setColor(this.value)">
                                    </div>
                                    <button class="tool-btn" title="Hapus Semua" onclick="clearCanvas()">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="canvas-container">
                            <canvas id="drawingCanvas"></canvas>
                            
                            <!-- Text Input Overlay -->
                            <div class="text-input-overlay" id="textInputOverlay">
                                <input type="text" id="canvasTextInput" placeholder="Ketik teks di sini..." maxlength="100">
                                <div class="text-actions">
                                    <button class="btn-text-cancel" onclick="cancelTextInput()">Batal</button>
                                    <button class="btn-text-ok" onclick="confirmTextInput()">Tambah</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-answer-section">
                        <div class="canvas-answer-header">Analisis & Jawaban AI</div>
                        <div class="canvas-answer-container"><div id="canvasAnswerArea"></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <video id="cameraVideo" autoplay playsinline></video>
        </div>
        <div class="camera-controls">
            <button class="btn-camera" onclick="takePhoto()"></button>
            <button class="btn-camera-cancel" onclick="closeCamera()">BATAL</button>
        </div>
    </div>
    
    <div class="save-modal" id="saveModal">
        <div class="save-options">
            <h3>SIMPAN HASIL BELAJAR</h3>
            <div class="save-btn-group">
                <button class="btn-save-option" onclick="saveAsPDF()">
                    <span class="icon">üìÑ</span>
                    <div>Simpan sebagai PDF</div>
                </button>
                <button class="btn-save-option" onclick="saveAsImage()">
                    <span class="icon">üñºÔ∏è</span>
                    <div>Simpan sebagai Gambar</div>
                </button>
            </div>
            <button class="btn-close-modal" onclick="closeSaveModal()">TUTUP</button>
        </div>
    </div>
    
    <div class="toast" id="toast">
        <div style="font-size: 24px;" id="toastIcon">‚úì</div>
        <div>
            <div style="font-weight: 700; font-size: 14px;" id="toastTitle">BERHASIL</div>
            <div style="font-size: 13px;" id="toastMessage">Operasi berhasil</div>
        </div>
    </div>

    <script>
        // === DATA MATA PELAJARAN PER JENJANG ===
        const SUBJECTS_DATA = {
            // SD (Kelas 1-6)
            'sd': {
                '1': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Seni dan Budaya', 'PJOK', 'Bahasa Inggris'],
                '2': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Seni dan Budaya', 'PJOK', 'Bahasa Inggris'],
                '3': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Seni dan Budaya', 'PJOK', 'Bahasa Inggris'],
                '4': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Ilmu Pengetahuan Sosial', 'Seni dan Budaya', 'PJOK', 'Bahasa Inggris'],
                '5': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Ilmu Pengetahuan Sosial', 'Seni dan Budaya', 'PJOK', 'Bahasa Inggris'],
                '6': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Ilmu Pengetahuan Sosial', 'Seni dan Budaya', 'PJOK', 'Bahasa Inggris']
            },
            // SMP (Kelas 7-9)
            'smp': {
                '7': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Ilmu Pengetahuan Sosial', 'Bahasa Inggris', 'Seni Budaya', 'PJOK', 'Informatika'],
                '8': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Ilmu Pengetahuan Sosial', 'Bahasa Inggris', 'Seni Budaya', 'PJOK', 'Informatika'],
                '9': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam', 'Ilmu Pengetahuan Sosial', 'Bahasa Inggris', 'Seni Budaya', 'PJOK', 'Informatika']
            },
            // SMA (Kelas 10-12)
            'sma': {
                '10': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika Wajib', 'Matematika Peminatan', 'Fisika', 'Kimia', 'Biologi', 'Ekonomi', 'Geografi', 'Sosiologi', 'Sejarah', 'Bahasa Inggris', 'Seni Budaya', 'PJOK', 'Informatika'],
                '11': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika Wajib', 'Matematika Peminatan', 'Fisika', 'Kimia', 'Biologi', 'Ekonomi', 'Geografi', 'Sosiologi', 'Sejarah', 'Bahasa Inggris', 'Seni Budaya', 'PJOK', 'Informatika'],
                '12': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika Wajib', 'Matematika Peminatan', 'Fisika', 'Kimia', 'Biologi', 'Ekonomi', 'Geografi', 'Sosiologi', 'Sejarah', 'Bahasa Inggris', 'Seni Budaya', 'PJOK', 'Informatika']
            }
        };

        // === STATE ===
        let currentMode = 'text', currentTool = 'pen', isDrawing = false, recognition = null, canvas, ctx, chatOpen = true, stream = null, currentUpload = null, questionCount = 0, isProcessing = false, apiReady = false;
        let startX, startY, snapshot = null, textInputX = 0, textInputY = 0;
        let currentGrade = '';
        let currentSubject = '';

        document.addEventListener('DOMContentLoaded', () => { 
            initCanvas(); 
            initVoice(); 
            testAPIConnection(); 
            
            const textarea = document.getElementById('messageInput'); 
            if(textarea) {
                textarea.addEventListener('input', function() { 
                    this.style.height = 'auto'; 
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px'; 
                });
            }
            
            checkResponsive(); 
            window.addEventListener('resize', checkResponsive);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.tool-dropdown')) {
                    closeAllDropdowns();
                }
            });
            
            // Enter key for text input
            document.getElementById('canvasTextInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmTextInput();
            });
        });

        // === PERUBAHAN KELAS & MATA PELAJARAN ===
        function changeGrade(grade) {
            currentGrade = grade;
            const subjectSelect = document.getElementById('subjectSelect');
            
            // Enable subject select
            subjectSelect.disabled = false;
            
            // Clear current options
            subjectSelect.innerHTML = '<option value="" disabled selected>Pilih Mata Pelajaran</option>';
            
            // Determine jenjang
            let jenjang = '';
            if (grade >= 1 && grade <= 6) jenjang = 'sd';
            else if (grade >= 7 && grade <= 9) jenjang = 'smp';
            else if (grade >= 10 && grade <= 12) jenjang = 'sma';
            
            // Get subjects for this grade
            const subjects = SUBJECTS_DATA[jenjang][grade] || [];
            
            // Add subjects to dropdown
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = `${jenjang}-${grade}-${subject.toLowerCase().replace(/\s+/g, '-')}`;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            
            showToast('üéì', 'KELAS DIPILIH', `Kelas ${grade} ${jenjang.toUpperCase()}`);
        }

        function changeSubject(subjectValue) {
            currentSubject = subjectValue;
            const subjectName = document.getElementById('subjectSelect').options[document.getElementById('subjectSelect').selectedIndex].text;
            showToast('üìö', 'MAPEL DIPILIH', subjectName);
        }

        async function testAPIConnection() {
            updateApiStatus('warning', 'Cek koneksi server...');
            try {
                const res = await fetch('/api/chat', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ test: true }) 
                });
                if(res.ok) { 
                    apiReady = true; 
                    updateApiStatus('active', 'Server Terhubung!'); 
                } else { 
                    throw new Error("Server Error"); 
                }
            } catch(e) { 
                updateApiStatus('error', 'Server tidak terhubung'); 
            }
        }

        function updateApiStatus(status, msg) { 
            const el = document.getElementById('apiStatus'); 
            el.className = `api-status ${status}`; 
            el.innerHTML = `<span>${status === 'active' ? '‚úì' : '!'}</span><span>${msg}</span>`; 
        }
        
        async function sendMessage() {
            if(!apiReady) { 
                showToast('!', 'OFFLINE', 'Server belum siap'); 
                return; 
            }
            if(isProcessing) return;
            
            const input = document.getElementById('messageInput'); 
            const text = input.value.trim();
            if(!text && !currentUpload) return;
            
            isProcessing = true; 
            addMessage(text, 'user'); 
            input.value = ''; 
            showTyping();
            
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: text, 
                        grade: currentGrade,
                        subject: currentSubject,
                        image: currentUpload 
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                addMessage(data.reply, 'bot');
                questionCount++; 
                updateCounterUI();
            } catch(err) { 
                addMessage("Error: " + err.message, 'bot'); 
            } finally { 
                isProcessing = false; 
                hideTyping(); 
                removeUpload(); 
            }
        }

        async function askFromContent() {
            if(!apiReady) return; 
            if(isProcessing) return;
            
            let q = ''; 
            let d = null;
            
            if(currentMode === 'text') { 
                q = document.getElementById('questionEditor').value.trim(); 
                if(!q) return; 
            } else { 
                d = canvas.toDataURL('image/png'); 
                q = 'Jelaskan gambar ini'; 
            }
            
            isProcessing = true; 
            if(!chatOpen) toggleChat(); 
            addMessage(q, 'user', d); 
            showTyping();
            
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: q, 
                        grade: currentGrade,
                        subject: currentSubject, 
                        image: d 
                    })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                addMessage(data.reply, 'bot');
                
                if(currentMode === 'text') {
                    document.getElementById('answerEditor').value = data.reply;
                } else {
                    document.getElementById('canvasAnswerArea').innerHTML = data.reply.replace(/\n/g, '<br>');
                }
                
                questionCount++; 
                updateCounterUI();
            } catch(err) { 
                addMessage("Error: " + err.message, 'bot'); 
            } finally { 
                isProcessing = false; 
                hideTyping(); 
            }
        }

        function clearQuestionText() {
            if (confirm('Yakin ingin menghapus semua teks pertanyaan?')) {
                document.getElementById('questionEditor').value = '';
                showToast('üóëÔ∏è', 'TERBERSIHKAN', 'Teks pertanyaan telah dihapus');
            }
        }

        function addMessage(t, s, i) { 
            const c = document.getElementById('chatMessages'); 
            const d = document.createElement('div'); 
            d.className = `message ${s}`; 
            if(i) {
                d.innerHTML = `<div>${t}</div><img src="${i}" style="max-width:100%;border-radius:8px;margin-top:8px">`;
            } else {
                d.innerHTML = t.replace(/\n/g, '<br>');
            }
            c.appendChild(d); 
            c.scrollTop = c.scrollHeight; 
        }
        
        function showTyping() { 
            const c = document.getElementById('chatMessages'); 
            if(document.getElementById('tid')) return; 
            const t = document.createElement('div'); 
            t.className = 'typing'; 
            t.id = 'tid'; 
            t.innerHTML = '<span></span><span></span><span></span>'; 
            c.appendChild(t); 
            c.scrollTop = c.scrollHeight; 
        }
        
        function hideTyping() { 
            const t = document.getElementById('tid'); 
            if(t) t.remove(); 
        }
        
        function handleKeyPress(e) { 
            if(e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMessage(); 
            } 
        }
        
        function updateCounterUI() {
            const maxLimit = 2000;
            const warningLimit = maxLimit * 0.95;
            const percentage = Math.min((questionCount / maxLimit) * 100, 100);
            const fillElement = document.getElementById('counterFill');
            const countElement = document.getElementById('counterValue');
            
            countElement.textContent = questionCount;
            fillElement.style.width = percentage + '%';
            
            if (questionCount >= warningLimit) {
                fillElement.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                countElement.style.color = '#ef4444';
            } else {
                fillElement.style.background = 'linear-gradient(90deg, var(--primary), #fb923c)';
                countElement.style.color = 'var(--primary)';
            }
        }
        
        function toggleChat() { 
            const s = document.getElementById('chatSidebar'); 
            const b = document.getElementById('btnOpenChat'); 
            chatOpen = !chatOpen; 
            if(chatOpen) { 
                s.classList.remove('closed'); 
                b.classList.remove('show'); 
            } else { 
                s.classList.add('closed'); 
                b.classList.add('show'); 
            } 
        }
        
        function handleFileUpload(e) { 
            const f = e.target.files[0]; 
            if(!f) return; 
            const r = new FileReader(); 
            r.onload = (ev) => { 
                currentUpload = ev.target.result; 
                document.getElementById('previewImage').src = currentUpload; 
                document.getElementById('uploadPreview').classList.add('active'); 
            }; 
            r.readAsDataURL(f); 
        }
        
        function removeUpload() { 
            currentUpload = null; 
            document.getElementById('uploadPreview').classList.remove('active'); 
        }
        
        function openCamera() { 
            const m = document.getElementById('cameraModal'); 
            const v = document.getElementById('cameraVideo'); 
            navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
                .then(s => {
                    stream = s;
                    v.srcObject = s;
                    m.classList.add('active');
                })
                .catch(e => alert('Tidak dapat mengakses kamera: ' + e)); 
        }
        
        function takePhoto() { 
            const v = document.getElementById('cameraVideo'); 
            const cc = document.createElement('canvas');
            cc.width = v.videoWidth; 
            cc.height = v.videoHeight; 
            cc.getContext('2d').drawImage(v, 0, 0); 
            currentUpload = cc.toDataURL('image/jpeg'); 
            document.getElementById('previewImage').src = currentUpload; 
            document.getElementById('uploadPreview').classList.add('active'); 
            closeCamera(); 
        }
        
        function closeCamera() { 
            document.getElementById('cameraModal').classList.remove('active'); 
            if(stream) { 
                stream.getTracks().forEach(t => t.stop()); 
                stream = null; 
            } 
        }
        
        function initVoice() { 
            if(!('webkitSpeechRecognition' in window)) return; 
            recognition = new webkitSpeechRecognition(); 
            recognition.lang = 'id-ID'; 
            recognition.onresult = (e) => {
                document.getElementById('messageInput').value = e.results[0][0].transcript;
            }; 
            recognition.onend = () => document.getElementById('voiceBtn').classList.remove('recording'); 
        }
        
        function toggleVoice() { 
            if(!recognition) return; 
            const b = document.getElementById('voiceBtn'); 
            if(b.classList.contains('recording')) {
                recognition.stop();
                b.classList.remove('recording');
            } else {
                recognition.start();
                b.classList.add('recording');
            } 
        }
        
        // === DROPDOWN TOOLBAR FUNCTIONS ===
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isOpen = dropdown.classList.contains('open');
            
            closeAllDropdowns();
            
            if (!isOpen) {
                dropdown.classList.add('open');
            }
        }
        
        function closeAllDropdowns() {
            document.querySelectorAll('.tool-dropdown').forEach(d => d.classList.remove('open'));
        }
        
        function selectTool(tool, label, icon) {
            currentTool = tool;
            
            // Update UI berdasarkan kategori tool
            if (tool === 'pen' || tool === 'line' || tool === 'curve') {
                document.getElementById('drawLabel').textContent = label;
                document.querySelector('#drawDropdown .icon').textContent = icon;
                updateActiveDropdownItem('drawDropdown', tool);
            } else if (['rect', 'square', 'circle', 'triangle', 'triangle-right', 'arrow'].includes(tool)) {
                document.getElementById('shapeLabel').textContent = label;
                document.querySelector('#shapeDropdown .icon').textContent = icon;
                updateActiveDropdownItem('shapeDropdown', tool);
            }
            
            closeAllDropdowns();
            
            // Update cursor
            if (tool === 'text' || tool === 'text-box') {
                canvas.style.cursor = 'text';
                showToast('T', 'MODE TEKS', 'Klik di kanvas untuk menambah teks');
            } else if (tool === 'eraser') {
                canvas.style.cursor = 'cell';
            } else {
                canvas.style.cursor = 'crosshair';
            }
        }
        
        function updateActiveDropdownItem(dropdownId, tool) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(`'${tool}'`)) {
                    item.classList.add('active');
                }
            });
        }
        
        // === TEXT INPUT FUNCTIONS ===
        function showTextInput(x, y) {
            const overlay = document.getElementById('textInputOverlay');
            const input = document.getElementById('canvasTextInput');
            
            textInputX = x;
            textInputY = y;
            
            // Position overlay near click but keep in bounds
            const container = document.querySelector('.canvas-container');
            const rect = container.getBoundingClientRect();
            
            let left = x;
            let top = y + 20;
            
            if (left + 200 > rect.width) left = rect.width - 220;
            if (top + 100 > rect.height) top = y - 100;
            
            overlay.style.left = left + 'px';
            overlay.style.top = top + 'px';
            overlay.classList.add('active');
            input.value = '';
            input.focus();
        }
        
        function confirmTextInput() {
            const input = document.getElementById('canvasTextInput');
            const text = input.value.trim();
            
            if (text) {
                drawTextOnCanvas(text, textInputX, textInputY);
            }
            
            hideTextInput();
        }
        
        function cancelTextInput() {
            hideTextInput();
        }
        
        function hideTextInput() {
            document.getElementById('textInputOverlay').classList.remove('active');
        }
        
        function drawTextOnCanvas(text, x, y) {
            ctx.font = 'bold 16px "Plus Jakarta Sans", sans-serif';
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.textBaseline = 'top';
            
            const metrics = ctx.measureText(text);
            const padding = 6;
            
            if (currentTool === 'text-box') {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.fillRect(x - padding, y - padding, metrics.width + (padding * 2), 28);
                ctx.strokeStyle = document.getElementById('colorPicker').value;
                ctx.lineWidth = 2;
                ctx.strokeRect(x - padding, y - padding, metrics.width + (padding * 2), 28);
            }
            
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.fillText(text, x, y);
            
            showToast('‚úì', 'TEKS DITAMBAH', `"${text.substring(0, 20)}${text.length > 20 ? '...' : ''}"`);
        }
        
        // === CANVAS FUNCTIONS ===
        function initCanvas() { 
            canvas = document.getElementById('drawingCanvas'); 
            ctx = canvas.getContext('2d'); 
            resizeCanvas(); 
            window.addEventListener('resize', resizeCanvas); 
            
            // Mouse events
            canvas.addEventListener('mousedown', startDraw); 
            canvas.addEventListener('mousemove', draw); 
            canvas.addEventListener('mouseup', stopDraw); 
            canvas.addEventListener('mouseout', stopDraw);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false}); 
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false}); 
            canvas.addEventListener('touchend', stopDraw);
            
            // Set default styles
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function resizeCanvas() { 
            if(!canvas) return; 
            const p = canvas.parentElement; 
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            if (canvas.width > 0) tempCtx.drawImage(canvas, 0, 0);
            
            canvas.width = p.offsetWidth; 
            canvas.height = p.offsetHeight;
            
            if (tempCanvas.width > 0) ctx.drawImage(tempCanvas, 0, 0);
        }
        
        function getCoords(e) { 
            const r = canvas.getBoundingClientRect(); 
            return { 
                x: (e.touches ? e.touches[0].clientX : e.clientX) - r.left, 
                y: (e.touches ? e.touches[0].clientY : e.clientY) - r.top 
            }; 
        }
        
        function startDraw(e) { 
            const c = getCoords(e);
            startX = c.x;
            startY = c.y;
            
            // Handle text tool
            if (currentTool === 'text' || currentTool === 'text-box') {
                showTextInput(c.x, c.y);
                return;
            }
            
            isDrawing = true;
            snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            ctx.beginPath(); 
            ctx.moveTo(c.x, c.y); 
            
            ctx.lineWidth = currentTool === 'eraser' ? 20 : (currentTool === 'pen' || currentTool === 'curve' ? 3 : 2);
            ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : document.getElementById('colorPicker').value;
            ctx.fillStyle = document.getElementById('colorPicker').value;
        }
        
        function draw(e) { 
            if(!isDrawing) return; 
            const c = getCoords(e);
            
            if (currentTool === 'pen' || currentTool === 'eraser' || currentTool === 'curve') {
                ctx.lineTo(c.x, c.y); 
                ctx.stroke();
            } else {
                ctx.putImageData(snapshot, 0, 0);
                drawShape(startX, startY, c.x, c.y);
            }
        }
        
        function drawShape(x1, y1, x2, y2) {
            ctx.beginPath();
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.lineWidth = 2;
            
            switch(currentTool) {
                case 'line':
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'rect':
                    ctx.strokeRect(x1, y1, x2-x1, y2-y1);
                    break;
                    
                case 'square':
                    const size = Math.max(Math.abs(x2-x1), Math.abs(y2-y1));
                    const sx = x2 > x1 ? x1 : x1 - size;
                    const sy = y2 > y1 ? y1 : y1 - size;
                    ctx.strokeRect(sx, sy, size, size);
                    break;
                    
                case 'circle':
                    const radius = Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2));
                    ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                    
                case 'triangle':
                    const side = Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2));
                    const height = (Math.sqrt(3)/2) * side;
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x1 + side, y1);
                    ctx.lineTo(x1 + side/2, y1 - height);
                    ctx.closePath();
                    ctx.stroke();
                    break;
                    
                case 'triangle-right':
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y1);
                    ctx.lineTo(x1, y2);
                    ctx.closePath();
                    ctx.stroke();
                    break;
                    
                case 'arrow':
                    const angle = Math.atan2(y2-y1, x2-x1);
                    const headLen = 15;
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(x2, y2);
                    ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI/6), y2 - headLen * Math.sin(angle - Math.PI/6));
                    ctx.moveTo(x2, y2);
                    ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI/6), y2 - headLen * Math.sin(angle + Math.PI/6));
                    ctx.stroke();
                    break;
            }
        }
        
        function stopDraw() { 
            if (!isDrawing) return;
            isDrawing = false; 
            ctx.beginPath(); 
        }
        
        function setColor(c) { 
            // Color updated via picker
        }
        
        function clearCanvas() { 
            if (confirm('Yakin ingin menghapus semua gambar?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                showToast('üóëÔ∏è', 'TERBERSIHKAN', 'Kanvas telah dibersihkan');
            }
        }
        
        function switchMode(m) { 
            currentMode = m; 
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); 
            if(event.target) event.target.classList.add('active'); 
            document.getElementById('textMode').classList.toggle('active', m === 'text'); 
            document.getElementById('canvasMode').classList.toggle('active', m === 'canvas'); 
            if(m === 'canvas') setTimeout(resizeCanvas, 100); 
        }
        
        function showToast(icon, title, message) { 
            const d = document.getElementById('toast'); 
            document.getElementById('toastIcon').textContent = icon; 
            document.getElementById('toastTitle').textContent = title; 
            document.getElementById('toastMessage').textContent = message; 
            d.classList.add('show'); 
            setTimeout(() => d.classList.remove('show'), 3000); 
        }
        
        function checkResponsive() { 
            if(window.innerWidth <= 767 && chatOpen) toggleChat(); 
        }
        
        function showSaveOptions() { 
            document.getElementById('saveModal').classList.add('active'); 
        }
        
        function closeSaveModal() { 
            document.getElementById('saveModal').classList.remove('active'); 
        }
        
        async function saveAsPDF() { 
            const {jsPDF} = window.jspdf; 
            const p = new jsPDF();
            
            // Header
            p.setFillColor(249, 115, 22);
            p.rect(0, 0, 210, 30, 'F');
            p.setTextColor(255, 255, 255);
            p.setFontSize(20);
            p.text('ROBO TEACHER', 20, 20);
            
            p.setTextColor(100, 100, 100);
            p.setFontSize(10);
            const gradeText = currentGrade ? `Kelas ${currentGrade}` : 'Belum memilih kelas';
            const subjectText = currentSubject ? document.getElementById('subjectSelect').options[document.getElementById('subjectSelect').selectedIndex].text : 'Belum memilih mapel';
            p.text(`Kelas: ${gradeText} | Mata Pelajaran: ${subjectText}`, 20, 40);
            p.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 20, 45);
            
            if (currentMode === 'text') {
                p.setTextColor(249, 115, 22);
                p.setFontSize(14);
                p.text('PERTANYAAN:', 20, 60);
                
                p.setTextColor(50, 50, 50);
                p.setFontSize(11);
                const questionText = document.getElementById('questionEditor').value || '(Tidak ada pertanyaan)';
                const splitQuestion = p.splitTextToSize(questionText, 170);
                p.text(splitQuestion, 20, 70);
                
                p.setTextColor(16, 185, 129);
                p.setFontSize(14);
                p.text('JAWABAN:', 20, 110);
                
                p.setTextColor(50, 50, 50);
                p.setFontSize(11);
                const answerText = document.getElementById('answerEditor').value || '(Belum ada jawaban)';
                const splitAnswer = p.splitTextToSize(answerText, 170);
                p.text(splitAnswer, 20, 120);
            } else {
                const imgData = canvas.toDataURL('image/png');
                p.addImage(imgData, 'PNG', 20, 55, 170, 100);
                
                const answerText = document.getElementById('canvasAnswerArea').innerText;
                if (answerText) {
                    p.setTextColor(16, 185, 129);
                    p.setFontSize(14);
                    p.text('ANALISIS AI:', 20, 165);
                    p.setTextColor(50, 50, 50);
                    p.setFontSize(11);
                    const splitAnswer = p.splitTextToSize(answerText, 170);
                    p.text(splitAnswer, 20, 175);
                }
            }
            
            p.save('robo-teacher-hasil-belajar.pdf'); 
            closeSaveModal(); 
            showToast('üìÑ', 'PDF TERSIMPAN', 'File berhasil diunduh');
        }
        
        async function saveAsImage() { 
            let elementToCapture;
            if (currentMode === 'text') {
                elementToCapture = document.getElementById('textMode');
            } else {
                elementToCapture = document.getElementById('canvasMode');
            }
            
            const c = await html2canvas(elementToCapture, {
                backgroundColor: '#ffffff',
                scale: 2
            }); 
            const l = document.createElement('a'); 
            l.href = c.toDataURL('image/png'); 
            l.download = `robo-teacher-${currentGrade || 'kelas'}-${Date.now()}.png`; 
            l.click(); 
            closeSaveModal(); 
            showToast('üñºÔ∏è', 'GAMBAR TERSIMPAN', 'Screenshot berhasil diunduh');
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if(e.key === 'Escape') {
                closeSaveModal();
                closeCamera();
                hideTextInput();
                closeAllDropdowns();
            }
        });
    </script>
</body>
</html>
