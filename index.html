<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROBO Teacher - Asisten Belajar AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Hide scrollbar but allow scrolling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Jika masih muncul, kita tutup dengan kotak putih mati */
        body::after {
            content: "";
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: #ffffff;
            z-index: 9999;
            pointer-events: all;
        }

        .app-container {
            display: flex;
            height: 100vh;
            height: 100dvh;
            position: relative;
        }

        /* Chat Sidebar */
        .chat-sidebar {
            width: 380px;
            min-width: 380px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.08);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 100;
        }

        .chat-sidebar.closed {
            transform: translateX(-100%);
            margin-right: -380px;
        }

        /* Header - Layout 2 Card Horizontal */
        .chat-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Card Container - 2 Card Sejajar */
        .header-cards {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        /* Card 1: Title Card */
        .title-card {
            flex: 1;
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .title-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }

        .title-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .title-text {
            flex: 1;
            position: relative;
            z-index: 1;
            min-width: 0;
        }

        .title-text h2 {
            font-size: 14px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .title-text .subtitle {
            font-size: 9px;
            color: rgba(255,255,255,0.9);
            letter-spacing: 0.5px;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Card 2: Counter Card */
        .counter-card {
            flex: 1;
            background: #ffffff;
            border-radius: 12px;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .counter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 4px;
        }

        .counter-label {
            font-size: 8px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .counter-value {
            font-size: 16px;
            font-weight: 800;
            color: #0ea5e9;
            font-family: 'Courier New', monospace;
            line-height: 1;
            white-space: nowrap;
        }

        .counter-bar-container {
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .counter-bar {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #22d3ee);
            transition: all 0.5s ease;
            border-radius: 3px;
        }

        .counter-bar.warning { 
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        
        .counter-bar.danger { 
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .counter-footer {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: #94a3b8;
            font-weight: 600;
            white-space: nowrap;
        }

        .refresh-date {
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 9px;
            text-align: center;
            color: #64748b;
            border: 1px solid #e2e8f0;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .switching-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            color: #b45309;
            background: #fef3c7;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #fde68a;
            margin-top: 8px;
        }

        .switching-indicator.active { display: flex; }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid #b45309;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-close-sidebar {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            color: #64748b;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            z-index: 10;
        }

        .btn-close-sidebar:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: rotate(90deg);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f8fafc;
        }

        .message {
            max-width: 90%;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            animation: messageSlide 0.3s ease;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            align-self: flex-start;
            background: #ffffff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-left: 8px;
        }

        .message.bot::before {
            content: 'ü§ñ';
            position: absolute;
            top: -8px;
            left: -8px;
            font-size: 16px;
            background: #0ea5e9;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            border: 1px solid #0ea5e9;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .message.system {
            align-self: center;
            background: #fef3c7;
            color: #92400e;
            font-size: 12px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #fde68a;
            max-width: 95%;
        }

        .message-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            display: block;
        }

        .typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #ffffff;
            border-radius: 12px;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: #0ea5e9;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* Chat Input */
        .chat-input-container {
            padding: 12px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
        }

        .upload-preview {
            display: none;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .upload-preview.active { display: block; }

        .upload-preview img {
            max-height: 80px;
            max-width: 100%;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        .btn-remove-upload {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            border: none;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .btn-tool {
            width: 36px;
            height: 36px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            color: #64748b;
            flex-shrink: 0;
        }

        .btn-tool:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
            color: #0ea5e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }

        .btn-tool input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .input-box {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: #f8fafc;
            border-radius: 10px;
            padding: 6px;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .input-box:focus-within {
            border-color: #0ea5e9;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.15);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 12px;
            outline: none;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            color: #1e293b;
            font-family: inherit;
            width: 100%;
        }

        #messageInput::placeholder {
            color: #94a3b8;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            color: #64748b;
            flex-shrink: 0;
        }

        .btn-icon:hover { 
            background: #f1f5f9; 
            color: #0ea5e9;
        }
        
        .btn-icon.voice { color: #ef4444; }
        .btn-icon.voice:hover { color: #dc2626; }
        
        .btn-icon.voice.recording { 
            animation: pulse 1s infinite; 
            background: #fef2f2;
            color: #dc2626;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .btn-send {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            flex-shrink: 0;
        }

        .btn-send:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
        }

        /* Open Chat Button */
        .btn-open-chat {
            position: fixed;
            left: 16px;
            bottom: 16px;
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #0ea5e9;
            border: 2px solid rgba(14, 165, 233, 0.4);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 
                0 8px 32px rgba(14, 165, 233, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            z-index: 99;
            transition: all 0.3s ease;
            animation: robotFloat 3s ease-in-out infinite;
        }

        @keyframes robotFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .btn-open-chat:hover {
            transform: scale(1.1);
            background: rgba(14, 165, 233, 0.15);
            color: #0284c7;
            border-color: rgba(14, 165, 233, 0.8);
        }

        .btn-open-chat.show { display: flex; }

        .chat-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #ffffff;
            animation: badgePulse 2s infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Main Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }

        .subject-select {
            padding: 10px 40px 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            background: #ffffff;
            cursor: pointer;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230ea5e9' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.2s;
            min-width: 180px;
            max-width: 100%;
        }

        .subject-select:hover, .subject-select:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.15);
        }

        .mode-toggle {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 3px;
            gap: 3px;
            border: 2px solid #e2e8f0;
            flex-shrink: 0;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mode-btn:hover { 
            color: #0ea5e9; 
            background: rgba(14, 165, 233, 0.1);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-ask {
            padding: 10px 18px;
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.3);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .btn-ask:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(14, 165, 233, 0.5);
        }

        .btn-save {
            padding: 10px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            white-space: nowrap;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.5);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            width: 100%;
            background: #ffffff;
        }

        .text-mode {
            flex: 1;
            padding: 24px;
            display: none;
            overflow-y: auto;
            width: 100%;
        }

        .text-mode.active { display: block; }

        .notes-editor {
            width: 100%;
            min-height: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.7;
            color: #1e293b;
            resize: none;
            font-family: 'Segoe UI', sans-serif;
            background: transparent;
        }

        .notes-editor::placeholder {
            color: #94a3b8;
        }

        .canvas-mode {
            flex: 1;
            display: none;
            position: relative;
            background: #ffffff;
            overflow: hidden;
            width: 100%;
        }

        .canvas-mode.active { display: block; }

        #drawingCanvas {
            cursor: crosshair;
            background: #ffffff;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        .canvas-tools {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            color: #64748b;
            flex-shrink: 0;
        }

        .tool-btn:hover, .tool-btn.active {
            border-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
        }

        .color-picker-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .color-picker {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            cursor: pointer;
            border: none;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .camera-modal.active { display: flex; }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            max-height: 70vh;
            border: 3px solid #0ea5e9;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(14, 165, 233, 0.5);
        }

        #cameraVideo {
            width: 100%;
            height: auto;
            display: block;
        }

        #cameraCanvas { display: none; }

        .camera-controls {
            display: flex;
            gap: 20px;
            margin-top: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-camera {
            width: 70px;
            height: 70px;
            border: 4px solid #0ea5e9;
            background: #ef4444;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            flex-shrink: 0;
        }

        .btn-camera:hover { 
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.8);
        }

        .btn-camera-cancel {
            padding: 12px 32px;
            background: transparent;
            color: #0ea5e9;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-camera-cancel:hover {
            background: rgba(14, 165, 233, 0.2);
        }

        /* Save Modal */
        .save-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .save-modal.active { display: flex; }

        .save-options {
            background: #ffffff;
            padding: 28px;
            border-radius: 16px;
            max-width: 420px;
            width: 100%;
            animation: popIn 0.3s ease;
            border: 1px solid #e2e8f0;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .save-options h3 {
            margin-bottom: 20px;
            color: #1e293b;
            text-align: center;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .save-btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-save-option {
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            font-size: 14px;
            color: #1e293b;
        }

        .btn-save-option:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
            transform: translateX(8px);
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.15);
        }

        .btn-save-option .icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .btn-save-option > div {
            flex: 1;
            min-width: 0;
        }

        .btn-close-modal {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #ffffff;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #0ea5e9;
            max-width: 90vw;
            width: auto;
            min-width: 280px;
        }

        .toast.show { display: flex; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ============================================
           RESPONSIVE DESIGN - MOBILE FIRST
           ============================================ */

        /* Extra Small Devices (phones, < 480px) */
        @media (max-width: 479px) {
            html {
                font-size: 14px;
            }

            .chat-sidebar {
                width: 100%;
                min-width: 100%;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 200;
            }

            .chat-sidebar.closed {
                transform: translateX(-100%);
                margin-right: 0;
            }

            .chat-header {
                padding: 12px;
            }

            .header-cards {
                flex-direction: column;
            }

            .title-card {
                padding: 10px;
            }

            .title-icon {
                width: 36px;
                height: 36px;
                font-size: 20px;
            }

            .title-text h2 {
                font-size: 13px;
            }

            .counter-card {
                padding: 8px 10px;
            }

            .counter-value {
                font-size: 14px;
            }

            .chat-messages {
                padding: 12px;
            }

            .message {
                font-size: 13px;
                padding: 10px 12px;
                max-width: 95%;
            }

            .chat-input-container {
                padding: 10px;
            }

            .toolbar {
                padding: 10px 12px;
                gap: 10px;
            }

            .toolbar-left {
                width: 100%;
                gap: 8px;
            }

            .subject-select {
                width: 100%;
                min-width: auto;
                font-size: 12px;
                padding: 8px 36px 8px 12px;
            }

            .mode-toggle {
                width: 100%;
            }

            .mode-btn {
                flex: 1;
                padding: 8px 12px;
                font-size: 11px;
                text-align: center;
            }

            .toolbar-actions {
                width: 100%;
                justify-content: stretch;
            }

            .btn-ask, .btn-save {
                flex: 1;
                justify-content: center;
                padding: 10px 12px;
                font-size: 12px;
            }

            .text-mode {
                padding: 16px;
            }

            .notes-editor {
                font-size: 15px;
            }

            .canvas-tools {
                top: 10px;
                left: 10px;
                padding: 8px;
                gap: 6px;
                flex-direction: row;
                flex-wrap: wrap;
                max-width: calc(100% - 20px);
            }

            .tool-btn, .color-picker-wrapper {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .save-options {
                padding: 20px;
                margin: 10px;
            }

            .save-options h3 {
                font-size: 16px;
            }

            .btn-save-option {
                padding: 12px 16px;
            }

            .btn-save-option .icon {
                font-size: 24px;
            }

            .camera-container {
                max-height: 60vh;
            }

            .btn-camera {
                width: 60px;
                height: 60px;
            }

            .toast {
                left: 10px;
                right: 10px;
                top: 10px;
                max-width: none;
                min-width: auto;
            }
        }

        /* Small Devices (phones, 480px - 767px) */
        @media (min-width: 480px) and (max-width: 767px) {
            .chat-sidebar {
                width: 100%;
                min-width: 100%;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                z-index: 200;
            }

            .chat-sidebar.closed {
                transform: translateX(-100%);
                margin-right: 0;
            }

            .header-cards {
                flex-direction: row;
            }

            .toolbar {
                padding: 12px;
            }

            .toolbar-left {
                gap: 10px;
            }

            .subject-select {
                min-width: 160px;
            }

            .mode-btn {
                padding: 8px 14px;
                font-size: 12px;
            }

            .btn-ask, .btn-save {
                padding: 10px 16px;
                font-size: 12px;
            }

            .canvas-tools {
                flex-direction: row;
            }
        }

        /* Medium Devices (tablets, 768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .chat-sidebar {
                width: 320px;
                min-width: 320px;
            }

            .chat-sidebar.closed {
                margin-right: -320px;
            }

            .header-cards {
                flex-direction: column;
            }

            .toolbar {
                padding: 12px 16px;
            }

            .subject-select {
                min-width: 180px;
            }

            .canvas-tools {
                flex-direction: column;
            }
        }

        /* Large Devices (laptops, 1024px - 1279px) */
        @media (min-width: 1024px) and (max-width: 1279px) {
            .chat-sidebar {
                width: 340px;
                min-width: 340px;
            }

            .chat-sidebar.closed {
                margin-right: -340px;
            }

            .header-cards {
                flex-direction: row;
            }

            .toolbar {
                padding: 14px 20px;
            }
        }

        /* Extra Large Devices (desktops, 1280px+) */
        @media (min-width: 1280px) {
            .chat-sidebar {
                width: 380px;
                min-width: 380px;
            }

            .chat-sidebar.closed {
                margin-right: -380px;
            }

            .chat-header {
                padding: 20px;
            }

            .header-cards {
                flex-direction: row;
                gap: 12px;
            }

            .title-card {
                padding: 15px;
            }

            .title-icon {
                width: 45px;
                height: 45px;
                font-size: 28px;
            }

            .title-text h2 {
                font-size: 16px;
            }

            .counter-card {
                padding: 12px 15px;
            }

            .counter-value {
                font-size: 20px;
            }

            .chat-messages {
                padding: 20px;
            }

            .message {
                font-size: 14px;
                padding: 14px 18px;
                max-width: 85%;
            }

            .chat-input-container {
                padding: 15px;
            }

            .toolbar {
                padding: 15px 25px;
            }

            .subject-select {
                padding: 12px 45px 12px 18px;
                font-size: 14px;
                min-width: 220px;
            }

            .mode-btn {
                padding: 10px 24px;
                font-size: 14px;
            }

            .btn-ask {
                padding: 12px 28px;
                font-size: 15px;
            }

            .btn-save {
                padding: 12px 24px;
                font-size: 15px;
            }

            .text-mode {
                padding: 40px;
            }

            .notes-editor {
                font-size: 18px;
            }

            .canvas-tools {
                top: 20px;
                left: 20px;
                padding: 15px;
            }

            .tool-btn, .color-picker-wrapper {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }
        }

        /* Landscape orientation for mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .chat-header {
                padding: 4px 8px;
            }

            .header-cards {
                flex-direction: row;
            }

            .title-card, .counter-card {
                padding: 4px 10px;
            }

            .title-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .refresh-date {
                display: none;
            }

            .chat-messages {
                padding: 10px;
            }

            .chat-input-container {
                padding: 8px;
            }

            .toolbar {
                padding: 8px 12px;
            }

            .canvas-tools {
                flex-direction: row;
                top: 8px;
                left: 8px;
                padding: 6px;
            }
        }

        /* High DPI / Retina displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .btn-tool, .tool-btn, .btn-icon, .btn-send {
                transform: translateZ(0);
            }
        }

        /* Print styles */
        @media print {
            .chat-sidebar,
            .btn-open-chat,
            .toolbar,
            .canvas-tools {
                display: none !important;
            }

            .workspace {
                width: 100% !important;
            }

            .text-mode, .canvas-mode {
                display: block !important;
                overflow: visible !important;
            }
        }

        /* Dark mode support (optional) */
        @media (prefers-color-scheme: dark) {
            /* Can be enabled if needed */
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
<base target="_blank">
</head>
<body>

    <div class="app-container">
        <!-- Chat Sidebar -->
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="chat-header">
                <button class="btn-close-sidebar" onclick="toggleChat()" title="Tutup Chat">√ó</button>
                
                <!-- 2 Card Sejajar -->
                <div class="header-cards">
                    <!-- Card 1: Title -->
                    <div class="title-card">
                        <div class="title-icon">ü§ñ</div>
                        <div class="title-text">
                            <h2>ROBO Teacher</h2>
                            <div class="subtitle">AI LEARNING v2.0</div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Counter -->
                    <div class="counter-card">
                        <div class="counter-header">
                            <span class="counter-label">BULAN INI</span>
                            <span class="counter-value" id="counterValue">0/1000</span>
                        </div>
                        <div class="counter-bar-container">
                            <div class="counter-bar" id="counterFill" style="width: 0%"></div>
                        </div>
                        <div class="counter-footer">
                            <span id="botActive">ROBO-01</span>
                            <span id="remainingCount">1000</span>
                        </div>
                    </div>
                </div>
                
                <div class="refresh-date" id="refreshDate">
                    REFRESH: 01 JAN 2025
                </div>
                
                <div class="switching-indicator" id="switchingIndicator">
                    <div class="spinner"></div>
                    <span>BERALIH KE BOT...</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    üëã Selamat datang! Saya ROBO Teacher, asisten AI untuk belajar. Pilih mata pelajaran dan mulai bertanya!
                </div>
            </div>

            <div class="chat-input-container">
                <div class="upload-preview" id="uploadPreview">
                    <img id="previewImage" src="" alt="Preview">
                    <button class="btn-remove-upload" onclick="removeUpload()" title="Hapus">√ó</button>
                </div>

                <div class="input-toolbar">
                    <button class="btn-tool" title="Upload Gambar">
                        üìÅ
                        <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                    </button>
                    <button class="btn-tool" onclick="openCamera()" title="Foto Kamera">üì∑</button>
                </div>

                <div class="input-box">
                    <textarea id="messageInput" placeholder="Ketik pertanyaanmu..." rows="1" onkeypress="handleKeyPress(event)"></textarea>
                    <div style="display: flex; gap: 4px;">
                        <button class="btn-icon voice" id="voiceBtn" onclick="toggleVoice()" title="Voice Input">üé§</button>
                        <button class="btn-send" onclick="sendMessage()" title="Kirim">‚û§</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Open Chat Button -->
        <button class="btn-open-chat" id="btnOpenChat" onclick="toggleChat()">
            ü§ñ
            <span class="chat-badge" id="chatBadge" style="display: none;">!</span>
        </button>

        <!-- Main Workspace -->
        <main class="workspace" id="workspace">
            <div class="toolbar">
                <div class="toolbar-left">
                    <select class="subject-select" id="subjectSelect" onchange="changeSubject(this.value)">
                        <optgroup label="üìö MATA PELAJARAN UTAMA">
                            <option value="b-indonesia">üáÆüá© Bahasa Indonesia</option>
                            <option value="matematika">üî¢ Matematika</option>
                            <option value="ppkn">üèõÔ∏è PPKn</option>
                            <option value="ipas">üî¨ IPAS</option>
                            <option value="sbdp">üé® SBdP</option>
                            <option value="pjok">üèÉ PJOK</option>
                        </optgroup>
                        <optgroup label="üåü MATA PELAJARAN TAMBAHAN">
                            <option value="b-inggris">üá¨üáß Bahasa Inggris</option>
                            <option value="b-daerah">üó£Ô∏è Bahasa Daerah</option>
                        </optgroup>
                    </select>

                    <div class="mode-toggle">
                        <button class="mode-btn active" onclick="switchMode('text')">üìù CATATAN</button>
                        <button class="mode-btn" onclick="switchMode('canvas')">üé® GAMBAR</button>
                    </div>
                </div>

                <div class="toolbar-actions">
                    <button class="btn-ask" onclick="askFromContent()">
                        <span>üöÄ</span>
                        <span>TANYAKAN</span>
                    </button>
                    <button class="btn-save" onclick="showSaveOptions()">
                        <span>üíæ</span>
                        <span>SIMPAN</span>
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- Text Mode -->
                <div class="text-mode active" id="textMode">
                    <textarea class="notes-editor" id="notesEditor" placeholder="üìù Area Catatan Digital

üí° Tips Penggunaan:
‚Ä¢ Tulis catatan pelajaranmu di sini
‚Ä¢ Gunakan mode GAMBAR untuk menggambar rumus/diagram
‚Ä¢ Klik TANYAKAN untuk kirim ke ROBO Teacher
‚Ä¢ Semua catatan tersimpan otomatis

üéØ Siap belajar! Pilih mata pelajaran dan mulai..."></textarea>
                </div>

                <!-- Canvas Mode -->
                <div class="canvas-mode" id="canvasMode">
                    <div class="canvas-tools">
                        <button class="tool-btn active" onclick="setTool('pen')" title="Pena">‚úèÔ∏è</button>
                        <button class="tool-btn" onclick="setTool('eraser')" title="Penghapus">üßπ</button>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-picker" id="colorPicker" value="#0ea5e9" onchange="setColor(this.value)">
                        </div>
                        <button class="tool-btn" onclick="clearCanvas()" title="Hapus Semua">üóëÔ∏è</button>
                        <button class="tool-btn" onclick="saveCanvasImage()" title="Simpan Gambar">üíæ</button>
                    </div>
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="cameraCanvas"></canvas>
        </div>
        <div class="camera-controls">
            <button class="btn-camera" onclick="takePhoto()" title="Ambil Foto"></button>
            <button class="btn-camera-cancel" onclick="closeCamera()">BATAL</button>
        </div>
    </div>

    <!-- Save Modal -->
    <div class="save-modal" id="saveModal">
        <div class="save-options">
            <h3>üíæ SIMPAN HASIL BELAJAR</h3>
            <div class="save-btn-group">
                <button class="btn-save-option" onclick="saveAsPDF()">
                    <span class="icon">üìÑ</span>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">SIMPAN SEBAGAI PDF</div>
                        <div style="font-size: 13px; color: #64748b;">Catatan dan gambar dalam satu file</div>
                    </div>
                </button>
                <button class="btn-save-option" onclick="saveAsJSON()">
                    <span class="icon">üìù</span>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">SIMPAN SEBAGAI JSON</div>
                        <div style="font-size: 13px; color: #64748b;">Data lengkap untuk dibuka lagi</div>
                    </div>
                </button>
                <button class="btn-save-option" onclick="saveAsImage()">
                    <span class="icon">üñºÔ∏è</span>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">SIMPAN SEBAGAI GAMBAR</div>
                        <div style="font-size: 13px; color: #64748b;">Screenshot halaman lengkap</div>
                    </div>
                </button>
            </div>
            <button class="btn-close-modal" onclick="closeSaveModal()">TUTUP</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div style="font-size: 24px;" id="toastIcon">‚úÖ</div>
        <div>
            <div style="font-weight: 700; color: #1e293b; margin-bottom: 4px; font-size: 14px;" id="toastTitle">BERHASIL</div>
            <div style="font-size: 13px; color: #64748b;" id="toastMessage">File telah disimpan</div>
        </div>
    </div>

    <script src="https://cdn.botpress.cloud/webchat/v2.2/inject.js"></script>

    <script>
        // ==========================================
        // KONFIGURASI 3 BOTPRESS BOTS
        // ==========================================
        const BOTS = [
            { 
                id: 'YOUR_BOT_ID_1_HERE',
                clientId: 'YOUR_CLIENT_ID_1_HERE',
                name: 'ROBO-01',
                color: '#0ea5e9'
            },
            { 
                id: 'YOUR_BOT_ID_2_HERE',
                clientId: 'YOUR_CLIENT_ID_2_HERE',
                name: 'ROBO-02',
                color: '#8b5cf6'
            },
            { 
                id: 'YOUR_BOT_ID_3_HERE',
                clientId: 'YOUR_CLIENT_ID_3_HERE',
                name: 'ROBO-03',
                color: '#10b981'
            }
        ];

        const MAX_CONVERSATIONS = 1000;
        const WARNING_THRESHOLD = 900;
        const CRITICAL_THRESHOLD = 980;

        let currentBotIndex = 0;
        let currentMode = 'text';
        let currentTool = 'pen';
        let isDrawing = false;
        let recognition = null;
        let canvas, ctx;
        let isSwitching = false;
        let currentUpload = null;
        let chatOpen = true;
        let stream = null;
        let conversationData = {
            month: null,
            botCounters: [0, 0, 0],
            currentBot: 0,
            warningWarned: false,
            criticalWarned: false
        };

        document.addEventListener('DOMContentLoaded', () => {
            initConversationData();
            initCanvas();
            initVoice();
            initBotpress();
            loadNotes();
            updateCounterUI();
            
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            checkResponsive();
            window.addEventListener('resize', checkResponsive);
            
            // Handle orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    resizeCanvas();
                    checkResponsive();
                }, 300);
            });
        });

        function checkResponsive() {
            const width = window.innerWidth;
            const sidebar = document.getElementById('chatSidebar');
            const openBtn = document.getElementById('btnOpenChat');
            
            // Mobile: auto-close sidebar on small screens
            if (width <= 767 && chatOpen) {
                toggleChat();
            }
            
            // Tablet: adjust sidebar based on preference
            if (width >= 768 && width <= 1023) {
                // Keep current state for tablet
            }
        }

        function initConversationData() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const saved = localStorage.getItem('roboConversationData');
            
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.month !== currentMonth) {
                    conversationData = {
                        month: currentMonth,
                        botCounters: [0, 0, 0],
                        currentBot: 0,
                        warningWarned: false,
                        criticalWarned: false
                    };
                    saveConversationData();
                    showToast('üîÑ', 'BULAN BARU', 'Counter direset untuk periode baru!');
                } else {
                    conversationData = parsed;
                    currentBotIndex = conversationData.currentBot;
                }
            } else {
                conversationData = {
                    month: currentMonth,
                    botCounters: [0, 0, 0],
                    currentBot: 0,
                    warningWarned: false,
                    criticalWarned: false
                };
                saveConversationData();
            }
            updateRefreshDate();
        }

        function saveConversationData() {
            localStorage.setItem('roboConversationData', JSON.stringify(conversationData));
        }

        function updateRefreshDate() {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            document.getElementById('refreshDate').textContent = 
                `REFRESH: ${nextMonth.toLocaleDateString('id-ID', options).toUpperCase()}`;
        }

        function incrementCounter() {
            conversationData.botCounters[currentBotIndex]++;
            conversationData.currentBot = currentBotIndex;
            saveConversationData();
            updateCounterUI();
            
            const count = conversationData.botCounters[currentBotIndex];
            
            if (count >= MAX_CONVERSATIONS) {
                autoSwitchBot();
            } else if (count >= CRITICAL_THRESHOLD && !conversationData.criticalWarned) {
                conversationData.criticalWarned = true;
                saveConversationData();
                showToast('‚ö†Ô∏è', 'PERINGATAN KRITIS', `${BOTS[currentBotIndex].name}: Tersisa ${MAX_CONVERSATIONS - count} percakapan!`);
            } else if (count >= WARNING_THRESHOLD && !conversationData.warningWarned) {
                conversationData.warningWarned = true;
                saveConversationData();
                showToast('üìä', 'INFO KUOTA', `${BOTS[currentBotIndex].name}: Sudah ${count} percakapan, beralih otomatis segera.`);
            }
        }

        function updateCounterUI() {
            const count = conversationData.botCounters[currentBotIndex];
            const remaining = MAX_CONVERSATIONS - count;
            const percentage = (count / MAX_CONVERSATIONS) * 100;
            
            document.getElementById('counterValue').textContent = `${count}/${MAX_CONVERSATIONS}`;
            document.getElementById('botActive').textContent = `${BOTS[currentBotIndex].name}`;
            document.getElementById('remainingCount').textContent = `${remaining}`;
            
            const fill = document.getElementById('counterFill');
            fill.style.width = `${percentage}%`;
            fill.className = 'counter-bar';
            
            if (count >= CRITICAL_THRESHOLD) {
                fill.classList.add('danger');
            } else if (count >= WARNING_THRESHOLD) {
                fill.classList.add('warning');
            }
        }

        function autoSwitchBot() {
            if (currentBotIndex >= BOTS.length - 1) {
                showToast('‚ùå', 'KUOTA HABIS', 'Semua 3 BOT telah mencapai batas maksimum!');
                document.getElementById('messageInput').disabled = true;
                document.getElementById('messageInput').placeholder = 'KUOTA HABIS - Hubungi admin';
                return;
            }

            isSwitching = true;
            const nextIndex = currentBotIndex + 1;
            
            document.getElementById('switchingIndicator').classList.add('active');
            addMessage(`üîÑ ${BOTS[currentBotIndex].name} PENUH (${MAX_CONVERSATIONS}/${MAX_CONVERSATIONS}). MENGALIHKAN KE ${BOTS[nextIndex].name}...`, 'system');
            
            setTimeout(() => {
                currentBotIndex = nextIndex;
                conversationData.currentBot = currentBotIndex;
                saveConversationData();
                initBotpress();
                
                document.getElementById('switchingIndicator').classList.remove('active');
                showToast('‚úÖ', 'BERHASIL BERGANTI', `${BOTS[currentBotIndex].name} AKTIF!`);
                addMessage(`‚úÖ ${BOTS[currentBotIndex].name} SIAP DIGUNAKAN! (${conversationData.botCounters[currentBotIndex]}/${MAX_CONVERSATIONS})`, 'bot');
                
                updateCounterUI();
                isSwitching = false;
            }, 2000);
        }

        function toggleChat() {
            const sidebar = document.getElementById('chatSidebar');
            const openBtn = document.getElementById('btnOpenChat');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                sidebar.classList.remove('closed');
                openBtn.classList.remove('show');
                document.getElementById('chatBadge').style.display = 'none';
            } else {
                sidebar.classList.add('closed');
                openBtn.classList.add('show');
            }
        }

        function initBotpress() {
            const bot = BOTS[currentBotIndex];
            try { 
                if (window.botpress && window.botpress.close) {
                    window.botpress.close(); 
                }
            } catch(e) {}
            
            window.botpress.init({
                botId: bot.id,
                clientId: bot.clientId,
                host: "https://cdn.botpress.cloud/webchat/v2.2",
                messagingUrl: "https://messaging.botpress.cloud",
                showPoweredBy: false,
                hideWidget: true,
                lazySocket: true
            });

            window.botpress.on('message', (msg) => {
                if (msg.type === 'text') {
                    hideTyping();
                    addMessage(msg.payload.text, 'bot');
                }
            });
        }

        function addMessage(text, sender, imageData = null) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            if (imageData) {
                div.innerHTML = `<div>${text}</div><img src="${imageData}" class="message-image" onclick="viewImage('${imageData}')">`;
            } else {
                div.textContent = text;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            if (!chatOpen && sender === 'bot') {
                document.getElementById('chatBadge').style.display = 'flex';
            }
        }

        function showTyping() {
            const container = document.getElementById('chatMessages');
            if (document.getElementById('typingIndicator')) return;
            
            const typing = document.createElement('div');
            typing.className = 'typing';
            typing.id = 'typingIndicator';
            typing.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator')?.remove();
        }

        function sendMessage() {
            if (isSwitching) {
                showToast('‚è≥', 'MOHON TUNGGU', 'Sedang beralih sistem BOT...');
                return;
            }

            if (conversationData.botCounters[currentBotIndex] >= MAX_CONVERSATIONS) {
                autoSwitchBot();
                return;
            }

            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text && !currentUpload) return;

            incrementCounter();

            if (currentUpload) {
                addMessage(text || 'üì∑ GAMBAR:', 'user', currentUpload);
                removeUpload();
            } else {
                addMessage(text, 'user');
            }
            
            input.value = '';
            input.style.height = 'auto';
            showTyping();
            
            if (window.botpress && window.botpress.sendMessage) {
                window.botpress.sendMessage({ text: text || 'Lihat gambar ini' });
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentUpload = e.target.result;
                showUploadPreview(currentUpload);
            };
            reader.readAsDataURL(file);
        }

        function showUploadPreview(imageData) {
            const preview = document.getElementById('uploadPreview');
            const img = document.getElementById('previewImage');
            img.src = imageData;
            preview.classList.add('active');
        }

        function removeUpload() {
            currentUpload = null;
            document.getElementById('uploadPreview').classList.remove('active');
            document.getElementById('fileInput').value = '';
        }

        function openCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then((s) => {
                    stream = s;
                    video.srcObject = stream;
                    modal.classList.add('active');
                })
                .catch((err) => {
                    showToast('‚ùå', 'ERROR KAMERA', err.message);
                });
        }

        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            currentUpload = canvas.toDataURL('image/jpeg');
            showUploadPreview(currentUpload);
            closeCamera();
            
            showToast('üì∑', 'BERHASIL', 'Foto diambil! Klik kirim untuk mengirim.');
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('active');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function viewImage(src) {
            window.open(src, '_blank');
        }

        function initVoice() {
            if (!('webkitSpeechRecognition' in window)) return;
            
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.continuous = false;
            
            recognition.onresult = (e) => {
                document.getElementById('messageInput').value = e.results[0][0].transcript;
                toggleVoice();
            };
            
            recognition.onend = () => {
                document.getElementById('voiceBtn').classList.remove('recording');
            };
        }

        function toggleVoice() {
            if (!recognition) return alert('Browser tidak mendukung voice input');
            
            const btn = document.getElementById('voiceBtn');
            if (btn.classList.contains('recording')) {
                recognition.stop();
                btn.classList.remove('recording');
            } else {
                recognition.start();
                btn.classList.add('recording');
            }
        }

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Mouse events
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            
            // Touch events with proper handling
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDraw);
            canvas.addEventListener('touchcancel', stopDraw);
        }

        function resizeCanvas() {
            const parent = canvas.parentElement;
            if (!parent) return;
            
            // Save current content
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            if (canvas.width > 0 && canvas.height > 0) {
                tempCtx.drawImage(canvas, 0, 0);
            }
            
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Restore content
            if (tempCanvas.width > 0 && tempCanvas.height > 0) {
                ctx.drawImage(tempCanvas, 0, 0);
            }
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const coords = getCoordinates(e);
            
            ctx.lineWidth = currentTool === 'eraser' ? 20 : 2;
            ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : document.getElementById('colorPicker').value;
            
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
            ctx.beginPath();
        }

        function handleTouchStart(e) {
            e.preventDefault();
            startDraw(e);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            draw(e);
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setColor(color) {
            currentTool = 'pen';
        }

        function clearCanvas() {
            if (confirm('Hapus semua gambar?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function saveCanvasImage() {
            const link = document.createElement('a');
            link.download = `robo-gambar-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showToast('üíæ', 'BERHASIL', 'Gambar disimpan!');
        }

        function askFromContent() {
            if (isSwitching) {
                showToast('‚è≥', 'MOHON TUNGGU', 'Sedang beralih sistem...');
                return;
            }

            if (conversationData.botCounters[currentBotIndex] >= MAX_CONVERSATIONS) {
                autoSwitchBot();
                return;
            }

            let question = '';
            
            if (currentMode === 'text') {
                question = document.getElementById('notesEditor').value.trim();
                if (!question) {
                    showToast('‚úèÔ∏è', 'AREA KOSONG', 'Tulis pertanyaan terlebih dahulu!');
                    document.getElementById('notesEditor').focus();
                    return;
                }
            } else {
                question = "[GAMBAR KANVAS] Bisakah ROBO Teacher menjelaskan gambar ini?";
                const canvasData = canvas.toDataURL('image/png');
                incrementCounter();
                addMessage(question, 'user', canvasData);
                showTyping();
                if (window.botpress && window.botpress.sendMessage) {
                    window.botpress.sendMessage({ text: question });
                }
                return;
            }
            
            if (!chatOpen) toggleChat();
            
            incrementCounter();
            addMessage(question, 'user');
            showTyping();
            if (window.botpress && window.botpress.sendMessage) {
                window.botpress.sendMessage({ text: question });
            }
        }

        function showSaveOptions() {
            document.getElementById('saveModal').classList.add('active');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
        }

        async function saveAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const subject = document.getElementById('subjectSelect');
            const subjectName = subject.options[subject.selectedIndex].text;
            
            pdf.setFontSize(22);
            pdf.text(`ROBO TEACHER - ${subjectName}`, 20, 25);
            pdf.setFontSize(12);
            pdf.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 20, 35);
            pdf.text(`Bot Aktif: ${BOTS[currentBotIndex].name}`, 20, 42);
            pdf.text(`Percakapan: ${conversationData.botCounters[currentBotIndex]}/${MAX_CONVERSATIONS}`, 20, 49);
            
            const notes = document.getElementById('notesEditor').value;
            if (notes) {
                pdf.setFontSize(11);
                const splitNotes = pdf.splitTextToSize(notes, 170);
                pdf.text(splitNotes, 20, 60);
            }
            
            if (currentMode === 'canvas') {
                const canvasData = canvas.toDataURL('image/png');
                pdf.addPage();
                pdf.text('GAMBAR:', 20, 20);
                pdf.addImage(canvasData, 'PNG', 20, 30, 170, 100);
            }
            
            pdf.save(`ROBO-${subjectName}-${Date.now()}.pdf`);
            closeSaveModal();
            showToast('üìÑ', 'PDF TERSIMPAN', 'File berhasil diunduh!');
        }

        function saveAsJSON() {
            const data = {
                roboVersion: "2.0",
                tanggal: new Date().toISOString(),
                mataPelajaran: document.getElementById('subjectSelect').value,
                catatan: document.getElementById('notesEditor').value,
                canvas: currentMode === 'canvas' ? canvas.toDataURL() : null,
                statistik: {
                    botAktif: BOTS[currentBotIndex].name,
                    percakapanBulanIni: conversationData.botCounters[currentBotIndex],
                    sisaKuota: MAX_CONVERSATIONS - conversationData.botCounters[currentBotIndex],
                    totalBots: BOTS.length,
                    refreshDate: document.getElementById('refreshDate').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ROBO-DATA-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeSaveModal();
            showToast('üìù', 'JSON TERSIMPAN', 'Data lengkap tersimpan!');
        }

        async function saveAsImage() {
            const workspace = document.getElementById('workspace');
            
            try {
                const canvas = await html2canvas(workspace, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    allowTaint: true
                });
                
                const link = document.createElement('a');
                link.download = `ROBO-SCREENSHOT-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                closeSaveModal();
                showToast('üñºÔ∏è', 'SCREENSHOT TERSIMPAN', 'Gambar halaman berhasil diunduh!');
            } catch (err) {
                showToast('‚ùå', 'GAGAL', 'Tidak dapat mengambil screenshot');
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('textMode').classList.toggle('active', mode === 'text');
            document.getElementById('canvasMode').classList.toggle('active', mode === 'canvas');
            
            if (mode === 'canvas') {
                setTimeout(resizeCanvas, 100);
            }
        }

        function changeSubject(subject) {
            saveNotes();
            loadNotes();
            const subjectName = event.target.options[event.target.selectedIndex].text;
            addMessage(`üìö BERALIH KE: ${subjectName.toUpperCase()}`, 'bot');
        }

        function saveNotes() {
            const subject = document.getElementById('subjectSelect').value;
            localStorage.setItem(`robo_notes_${subject}`, document.getElementById('notesEditor').value);
        }

        function loadNotes() {
            const subject = document.getElementById('subjectSelect').value;
            document.getElementById('notesEditor').value = localStorage.getItem(`robo_notes_${subject}`) || '';
        }

        function showToast(icon, title, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        let saveTimeout;
        document.getElementById('notesEditor').addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveNotes, 1000);
        });

        document.getElementById('saveModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeSaveModal();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSaveModal();
                closeCamera();
            }
        });
    </script>
</body>
</html>
