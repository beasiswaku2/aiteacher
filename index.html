<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROBO Teacher SD - Asisten Belajar AI (Groq Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            touch-action: manipulation;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        body::after {
            content: "";
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: #ffffff;
            z-index: 9999;
            pointer-events: all;
        }

        .app-container {
            display: flex;
            height: 100vh;
            height: 100dvh;
            position: relative;
        }

        /* Chat Sidebar */
        .chat-sidebar {
            width: 380px;
            min-width: 380px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.08);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 100;
        }

        .chat-sidebar.closed {
            transform: translateX(-100%);
            margin-right: -380px;
        }

        /* Header - Layout 2 Card Horizontal */
        .chat-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Card Container - 2 Card Sejajar */
        .header-cards {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        /* Card 1: Title Card */
        .title-card {
            flex: 1;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .title-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }

        .title-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .title-text {
            flex: 1;
            position: relative;
            z-index: 1;
            min-width: 0;
        }

        .title-text h2 {
            font-size: 14px;
            font-weight: 800;
            color: white;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .title-text .subtitle {
            font-size: 9px;
            color: rgba(255,255,255,0.9);
            letter-spacing: 0.5px;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Card 2: Counter Card */
        .counter-card {
            flex: 1;
            background: #ffffff;
            border-radius: 12px;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .counter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            gap: 4px;
        }

        .counter-label {
            font-size: 8px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .counter-value {
            font-size: 16px;
            font-weight: 800;
            color: #f97316;
            font-family: 'Courier New', monospace;
            line-height: 1;
            white-space: nowrap;
        }

        .counter-bar-container {
            height: 5px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .counter-bar {
            height: 100%;
            background: linear-gradient(90deg, #f97316, #fb923c);
            transition: all 0.5s ease;
            border-radius: 3px;
        }

        .counter-bar.warning { 
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        
        .counter-bar.danger { 
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .counter-footer {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: #94a3b8;
            font-weight: 600;
            white-space: nowrap;
        }

        .refresh-date {
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 9px;
            text-align: center;
            color: #64748b;
            border: 1px solid #e2e8f0;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .api-status.active {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .api-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .api-status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .api-status:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-close-sidebar {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            color: #64748b;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            z-index: 10;
        }

        .btn-close-sidebar:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: rotate(90deg);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f8fafc;
        }

        .message {
            max-width: 90%;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            animation: messageSlide 0.3s ease;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            align-self: flex-start;
            background: #ffffff;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-left: 8px;
        }

        .message.bot::before {
            content: 'ü§ñ';
            position: absolute;
            top: -8px;
            left: -8px;
            font-size: 16px;
            background: #f97316;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: 1px solid #f97316;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        .message.system {
            align-self: center;
            background: #fef3c7;
            color: #92400e;
            font-size: 12px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #fde68a;
            max-width: 95%;
        }

        .message.error {
            align-self: center;
            background: #fee2e2;
            color: #991b1b;
            font-size: 12px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #fca5a5;
            max-width: 95%;
        }

        .message-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            display: block;
        }

        .typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #ffffff;
            border-radius: 12px;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: #f97316;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* Chat Input */
        .chat-input-container {
            padding: 12px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
        }

        .upload-preview {
            display: none;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .upload-preview.active { display: block; }

        .upload-preview img {
            max-height: 80px;
            max-width: 100%;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        .btn-remove-upload {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            border: none;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .btn-tool {
            width: 36px;
            height: 36px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            color: #64748b;
            flex-shrink: 0;
        }

        .btn-tool:hover {
            border-color: #f97316;
            background: #fff7ed;
            color: #f97316;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }

        .btn-tool input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .input-box {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: #f8fafc;
            border-radius: 10px;
            padding: 6px;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }

        .input-box:focus-within {
            border-color: #f97316;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.15);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 12px;
            outline: none;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            color: #1e293b;
            font-family: inherit;
            width: 100%;
        }

        #messageInput::placeholder {
            color: #94a3b8;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            color: #64748b;
            flex-shrink: 0;
        }

        .btn-icon:hover { 
            background: #f1f5f9; 
            color: #f97316;
        }
        
        .btn-icon.voice { color: #ef4444; }
        .btn-icon.voice:hover { color: #dc2626; }
        
        .btn-icon.voice.recording { 
            animation: pulse 1s infinite; 
            background: #fef2f2;
            color: #dc2626;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .btn-send {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
            flex-shrink: 0;
        }

        .btn-send:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5);
        }

        /* Open Chat Button */
        .btn-open-chat {
            position: fixed;
            left: 16px;
            bottom: 16px;
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #f97316;
            border: 2px solid rgba(249, 115, 22, 0.4);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 
                0 8px 32px rgba(249, 115, 22, 0.2),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            z-index: 99;
            transition: all 0.3s ease;
            animation: robotFloat 3s ease-in-out infinite;
        }

        @keyframes robotFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .btn-open-chat:hover {
            transform: scale(1.1);
            background: rgba(249, 115, 22, 0.15);
            color: #ea580c;
            border-color: rgba(249, 115, 22, 0.8);
        }

        .btn-open-chat.show { display: flex; }

        .chat-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #ffffff;
            animation: badgePulse 2s infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Main Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }

        .subject-select {
            padding: 10px 40px 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            background: #ffffff;
            cursor: pointer;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f97316' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.2s;
            min-width: 180px;
            max-width: 100%;
        }

        .subject-select:hover, .subject-select:focus {
            border-color: #f97316;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.15);
        }

        .mode-toggle {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 3px;
            gap: 3px;
            border: 2px solid #e2e8f0;
            flex-shrink: 0;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mode-btn:hover { 
            color: #f97316; 
            background: rgba(249, 115, 22, 0.1);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-ask {
            padding: 10px 18px;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .btn-ask:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(249, 115, 22, 0.5);
        }

        .btn-save {
            padding: 10px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            white-space: nowrap;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.5);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            width: 100%;
            background: #ffffff;
        }

        .text-mode {
            flex: 1;
            padding: 24px;
            display: none;
            overflow-y: auto;
            width: 100%;
        }

        .text-mode.active { display: block; }

        .notes-editor {
            width: 100%;
            min-height: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            line-height: 1.7;
            color: #1e293b;
            resize: none;
            font-family: 'Segoe UI', sans-serif;
            background: transparent;
        }

        .notes-editor::placeholder {
            color: #94a3b8;
        }

        .canvas-mode {
            flex: 1;
            display: none;
            position: relative;
            background: #ffffff;
            overflow: hidden;
            width: 100%;
        }

        .canvas-mode.active { display: block; }

        #drawingCanvas {
            cursor: crosshair;
            background: #ffffff;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        .canvas-tools {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            color: #64748b;
            flex-shrink: 0;
        }

        .tool-btn:hover, .tool-btn.active {
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
            color: #f97316;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.2);
        }

        .color-picker-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .color-picker {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            cursor: pointer;
            border: none;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .camera-modal.active { display: flex; }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            max-height: 70vh;
            border: 3px solid #f97316;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(249, 115, 22, 0.5);
        }

        #cameraVideo {
            width: 100%;
            height: auto;
            display: block;
        }

        #cameraCanvas { display: none; }

        .camera-controls {
            display: flex;
            gap: 20px;
            margin-top: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-camera {
            width: 70px;
            height: 70px;
            border: 4px solid #f97316;
            background: #ef4444;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            flex-shrink: 0;
        }

        .btn-camera:hover { 
            transform: scale(1.1);
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.8);
        }

        .btn-camera-cancel {
            padding: 12px 32px;
            background: transparent;
            color: #f97316;
            border: 2px solid #f97316;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-camera-cancel:hover {
            background: rgba(249, 115, 22, 0.2);
        }

        /* Save Modal */
        .save-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .save-modal.active { display: flex; }

        .save-options {
            background: #ffffff;
            padding: 28px;
            border-radius: 16px;
            max-width: 420px;
            width: 100%;
            animation: popIn 0.3s ease;
            border: 1px solid #e2e8f0;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .save-options h3 {
            margin-bottom: 20px;
            color: #1e293b;
            text-align: center;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .save-btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-save-option {
            padding: 14px 20px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            font-size: 14px;
            color: #1e293b;
        }

        .btn-save-option:hover {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateX(8px);
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.15);
        }

        .btn-save-option .icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .btn-save-option > div {
            flex: 1;
            min-width: 0;
        }

        .btn-close-modal {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        /* API Key Modal */
        .apikey-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .apikey-modal.active { display: flex; }

        .apikey-content {
            background: #ffffff;
            padding: 28px;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            animation: popIn 0.3s ease;
            border: 1px solid #e2e8f0;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .apikey-content h3 {
            margin-bottom: 16px;
            color: #1e293b;
            text-align: center;
            font-size: 20px;
        }

        .apikey-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            font-family: 'Courier New', monospace;
        }

        .apikey-input:focus {
            border-color: #f97316;
            outline: none;
        }

        .apikey-help {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
            color: #9a3412;
            line-height: 1.6;
        }

        .btn-save-apikey {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save-apikey:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.4);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #ffffff;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #f97316;
            max-width: 90vw;
            width: auto;
            min-width: 280px;
        }

        .toast.show { display: flex; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Grade Level Indicator */
        .grade-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 10px;
        }

        /* Subject Info Panel */
        .subject-info {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #9a3412;
            line-height: 1.5;
        }

        /* Vision Badge */
        .vision-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* ============================================
           RESPONSIVE DESIGN - MOBILE FIRST
           ============================================ */

        @media (max-width: 479px) {
            html { font-size: 14px; }
            .chat-sidebar { width: 100%; min-width: 100%; position: fixed; top: 0; bottom: 0; left: 0; z-index: 200; }
            .chat-sidebar.closed { transform: translateX(-100%); margin-right: 0; }
            .chat-header { padding: 12px; }
            .header-cards { flex-direction: column; }
            .title-card { padding: 10px; }
            .title-icon { width: 36px; height: 36px; font-size: 20px; }
            .title-text h2 { font-size: 13px; }
            .counter-card { padding: 8px 10px; }
            .counter-value { font-size: 14px; }
            .chat-messages { padding: 12px; }
            .message { font-size: 13px; padding: 10px 12px; max-width: 95%; }
            .chat-input-container { padding: 10px; }
            .toolbar { padding: 10px 12px; gap: 10px; }
            .toolbar-left { width: 100%; gap: 8px; }
            .subject-select { width: 100%; min-width: auto; font-size: 12px; padding: 8px 36px 8px 12px; }
            .mode-toggle { width: 100%; }
            .mode-btn { flex: 1; padding: 8px 12px; font-size: 11px; text-align: center; }
            .toolbar-actions { width: 100%; justify-content: stretch; }
            .btn-ask, .btn-save { flex: 1; justify-content: center; padding: 10px 12px; font-size: 12px; }
            .text-mode { padding: 16px; }
            .notes-editor { font-size: 15px; }
            .canvas-tools { top: 10px; left: 10px; padding: 8px; gap: 6px; flex-direction: row; flex-wrap: wrap; max-width: calc(100% - 20px); }
            .tool-btn, .color-picker-wrapper { width: 36px; height: 36px; font-size: 16px; }
            .save-options, .apikey-content { padding: 20px; margin: 10px; }
            .save-options h3, .apikey-content h3 { font-size: 16px; }
            .btn-save-option { padding: 12px 16px; }
            .btn-save-option .icon { font-size: 24px; }
            .camera-container { max-height: 60vh; }
            .btn-camera { width: 60px; height: 60px; }
            .toast { left: 10px; right: 10px; top: 10px; max-width: none; min-width: auto; }
            .subject-info { display: none; }
        }

        @media (min-width: 480px) and (max-width: 767px) {
            .chat-sidebar { width: 100%; min-width: 100%; position: fixed; top: 0; bottom: 0; left: 0; z-index: 200; }
            .chat-sidebar.closed { transform: translateX(-100%); margin-right: 0; }
            .header-cards { flex-direction: row; }
            .toolbar { padding: 12px; }
            .toolbar-left { gap: 10px; }
            .subject-select { min-width: 160px; }
            .mode-btn { padding: 8px 14px; font-size: 12px; }
            .btn-ask, .btn-save { padding: 10px 16px; font-size: 12px; }
            .canvas-tools { flex-direction: row; }
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .chat-sidebar { width: 320px; min-width: 320px; }
            .chat-sidebar.closed { margin-right: -320px; }
            .header-cards { flex-direction: column; }
            .toolbar { padding: 12px 16px; }
            .subject-select { min-width: 180px; }
            .canvas-tools { flex-direction: column; }
        }

        @media (min-width: 1024px) and (max-width: 1279px) {
            .chat-sidebar { width: 340px; min-width: 340px; }
            .chat-sidebar.closed { margin-right: -340px; }
            .header-cards { flex-direction: row; }
            .toolbar { padding: 14px 20px; }
        }

        @media (min-width: 1280px) {
            .chat-sidebar { width: 380px; min-width: 380px; }
            .chat-sidebar.closed { margin-right: -380px; }
            .chat-header { padding: 20px; }
            .header-cards { flex-direction: row; gap: 12px; }
            .title-card { padding: 15px; }
            .title-icon { width: 45px; height: 45px; font-size: 28px; }
            .title-text h2 { font-size: 16px; }
            .counter-card { padding: 12px 15px; }
            .counter-value { font-size: 20px; }
            .chat-messages { padding: 20px; }
            .message { font-size: 14px; padding: 14px 18px; max-width: 85%; }
            .chat-input-container { padding: 15px; }
            .toolbar { padding: 15px 25px; }
            .subject-select { padding: 12px 45px 12px 18px; font-size: 14px; min-width: 220px; }
            .mode-btn { padding: 10px 24px; font-size: 14px; }
            .btn-ask { padding: 12px 28px; font-size: 15px; }
            .btn-save { padding: 12px 24px; font-size: 15px; }
            .text-mode { padding: 40px; }
            .notes-editor { font-size: 18px; }
            .canvas-tools { top: 20px; left: 20px; padding: 15px; }
            .tool-btn, .color-picker-wrapper { width: 45px; height: 45px; font-size: 22px; }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .chat-header { padding: 4px 8px; }
            .header-cards { flex-direction: row; }
            .title-card, .counter-card { padding: 4px 10px; }
            .title-icon { width: 32px; height: 32px; font-size: 14px; }
            .refresh-date { display: none; }
            .chat-messages { padding: 10px; }
            .chat-input-container { padding: 8px; }
            .toolbar { padding: 8px 12px; }
            .canvas-tools { flex-direction: row; top: 8px; left: 8px; padding: 6px; }
            .subject-info { display: none; }
        }

        @media print {
            .chat-sidebar, .btn-open-chat, .toolbar, .canvas-tools { display: none !important; }
            .workspace { width: 100% !important; }
            .text-mode, .canvas-mode { display: block !important; overflow: visible !important; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Chat Sidebar -->
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="chat-header">
                <button class="btn-close-sidebar" onclick="toggleChat()" title="Tutup Chat">√ó</button>
                
                <div class="header-cards">
                    <div class="title-card">
                        <div class="title-icon">ü§ñ</div>
                        <div class="title-text">
                            <h2>ROBO Teacher</h2>
                            <div class="subtitle">SD KELAS 3-6</div>
                        </div>
                    </div>
                    
                    <div class="counter-card">
                        <div class="counter-header">
                            <span class="counter-label">PERTANYAAN</span>
                            <span class="counter-value" id="counterValue">0</span>
                        </div>
                        <div class="counter-bar-container">
                            <div class="counter-bar" id="counterFill" style="width: 0%"></div>
                        </div>
                        <div class="counter-footer">
                            <span id="apiProvider">GROQ</span>
                            <span id="remainingCount">FREE TIER</span>
                        </div>
                    </div>
                </div>
                
                <div class="refresh-date" id="refreshDate">
                    API: GROQ CLOUD
                </div>
                
                <div class="api-status warning" id="apiStatus" onclick="showApiKeyModal()">
                    <span>‚ö†Ô∏è</span>
                    <span>Klik untuk setting API Key</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    üëã Halo! Saya ROBO Teacher untuk SD Kelas 3-6.<br><br>
                    ‚ö†Ô∏è <strong>Perhatian:</strong> API Key Groq belum di-set. Klik tombol kuning di atas untuk mengatur API Key.<br><br>
                    üéØ Mata Pelajaran:<br>
                    ‚Ä¢ PKn, Bahasa Indonesia, Matematika<br>
                    ‚Ä¢ IPAS, SBdP, PJOK<br>
                    ‚Ä¢ Bahasa Inggris & Daerah<br><br>
                    <strong>Cara mendapatkan API Key Groq:</strong><br>
                    1. Buka console.groq.com<br>
                    2. Sign up gratis<br>
                    3. Klik "Create API Key"<br>
                    4. Paste di sini
                </div>
            </div>

            <div class="chat-input-container">
                <div class="upload-preview" id="uploadPreview">
                    <img id="previewImage" src="" alt="Preview">
                    <button class="btn-remove-upload" onclick="removeUpload()" title="Hapus">√ó</button>
                </div>

                <div class="input-toolbar">
                    <button class="btn-tool" title="Upload Gambar">
                        üìÅ
                        <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                    </button>
                    <button class="btn-tool" onclick="openCamera()" title="Foto Kamera">üì∑</button>
                </div>

                <div class="input-box">  			  
                    <textarea id="messageInput" placeholder="Ketik pertanyaanmu..." rows="3" onkeypress="handleKeyPress(event)"></textarea>
                </div>
                <div class="button-card" style="
                    display: inline-flex;
                    gap: 20px;
                    padding: 5px;
                    background: linear-gradient(145deg, #f5f7fa 0%, #c3cfe2 100%);
                    border-radius: 20px;
                    box-shadow: 5px 5px 15px rgba(0,0,0,0.1), 
                                -5px -5px 15px rgba(255,255,255,0.8);
                ">
                    <button class="btn-icon voice" id="voiceBtn" onclick="toggleVoice()" title="Voice Input" style="
                        background: #ffffff;
                        border: none;
                        border-radius: 12px;
                        padding: 12px;
                        cursor: pointer;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                        transition: transform 0.2s;
                    ">üé§</button>
                    <button class="btn-send" onclick="sendMessage()" title="Kirim" style="
                        background: #ffffff;
                        color: #f97316;
                        border: none;
                        border-radius: 12px;
                        padding: 12px 18px;
                        cursor: pointer;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                        transition: transform 0.2s;
                    ">‚û§</button>
                </div>
            </div>
        </aside>

        <!-- Open Chat Button -->
        <button class="btn-open-chat" id="btnOpenChat" onclick="toggleChat()">
            ü§ñ
            <span class="chat-badge" id="chatBadge" style="display: none;">!</span>
        </button>

        <!-- Main Workspace -->
        <main class="workspace" id="workspace">
            <div class="toolbar">
                <div class="toolbar-left">
                    <select class="subject-select" id="subjectSelect" onchange="changeSubject(this.value)">
                        <optgroup label="üèõÔ∏è PENDIDIKAN PANCASILA & KEWARGANEGARAAN">
                            <option value="pkn-3">PKn Kelas 3 - Pancasila & UUD</option>
                            <option value="pkn-4">PKn Kelas 4 - NKRI & Bhinneka</option>
                            <option value="pkn-5">PKn Kelas 5 - HAM & Demokrasi</option>
                            <option value="pkn-6">PKn Kelas 6 - Globalisasi</option>
                        </optgroup>
                        <optgroup label="üáÆüá© BAHASA INDONESIA">
                            <option value="bindonesia-3">B. Indonesia Kelas 3 - Membaca & Menulis</option>
                            <option value="bindonesia-4">B. Indonesia Kelas 4 - Puisi & Cerita</option>
                            <option value="bindonesia-5">B. Indonesia Kelas 5 - Teks Laporan</option>
                            <option value="bindonesia-6">B. Indonesia Kelas 6 - Resensi & Diskusi</option>
                        </optgroup>
                        <optgroup label="üî¢ MATEMATIKA">
                            <option value="matematika-3">Matematika Kelas 3 - Perkalian/Pembagian</option>
                            <option value="matematika-4">Matematika Kelas 4 - Pecahan & Bangun</option>
                            <option value="matematika-5">Matematika Kelas 5 - Operasi Campuran</option>
                            <option value="matematika-6">Matematika Kelas 6 - Bilangan Bulat</option>
                        </optgroup>
                        <optgroup label="üåç IPAS (IPA & IPS)">
                            <option value="ipas-3">IPAS Kelas 3 - Makhluk Hidup</option>
                            <option value="ipas-4">IPAS Kelas 4 - Energi & Gaya</option>
                            <option value="ipas-5">IPAS Kelas 5 - Bumi & Alam Semesta</option>
                            <option value="ipas-6">IPAS Kelas 6 - Bioteknologi</option>
                        </optgroup>
                        <optgroup label="üé® SENI BUDAYA & PRAKARYA">
                            <option value="sbdp-3">SBdP Kelas 3 - Menggambar & Melukis</option>
                            <option value="sbdp-4">SBdP Kelas 4 - Musik & Tari</option>
                            <option value="sbdp-5">SBdP Kelas 5 - Kerajinan</option>
                            <option value="sbdp-6">SBdP Kelas 6 - Desain & Karya</option>
                        </optgroup>
                        <optgroup label="üèÉ PENDIDIKAN JASMANI">
                            <option value="pjok-3">PJOK Kelas 3 - Gerak Dasar</option>
                            <option value="pjok-4">PJOK Kelas 4 - Permainan Bola</option>
                            <option value="pjok-5">PJOK Kelas 5 - Atletik</option>
                            <option value="pjok-6">PJOK Kelas 6 - Kesehatan & Kebugaran</option>
                        </optgroup>
                        <optgroup label="üåü MATA PELAJARAN TAMBAHAN">
                            <option value="binggris-3">Bahasa Inggris Kelas 3</option>
                            <option value="binggris-4">Bahasa Inggris Kelas 4</option>
                            <option value="binggris-5">Bahasa Inggris Kelas 5</option>
                            <option value="binggris-6">Bahasa Inggris Kelas 6</option>
                            <option value="bdaerah-3">Bahasa Daerah Kelas 3</option>
                            <option value="bdaerah-4">Bahasa Daerah Kelas 4</option>
                            <option value="bdaerah-5">Bahasa Daerah Kelas 5</option>
                            <option value="bdaerah-6">Bahasa Daerah Kelas 6</option>
                        </optgroup>
                    </select>
                    <span class="grade-indicator" id="gradeIndicator">KELAS 3</span>
                    <span class="vision-badge" id="visionBadge" title="Vision AI Ready">üëÅÔ∏è VISION</span>

                    <div class="mode-toggle">
                        <button class="mode-btn active" onclick="switchMode('text')">üìù CATATAN</button>
                        <button class="mode-btn" onclick="switchMode('canvas')">üé® GAMBAR</button>
                    </div>
                </div>

                <div class="toolbar-actions">
                    <button class="btn-ask" onclick="askFromContent()">
                        <span>üöÄ</span>
                        <span>TANYAKAN</span>
                    </button>
                    <button class="btn-save" onclick="showSaveOptions()">
                        <span>üíæ</span>
                        <span>SIMPAN</span>
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- Text Mode -->
                <div class="text-mode active" id="textMode">
                    <div class="subject-info" id="subjectInfo">
                        <strong>üìö PKn Kelas 3:</strong> Mempelajari Pancasila sebagai dasar negara, UUD 1945, dan semboyan Bhinneka Tunggal Ika.
                    </div>
                    <textarea class="notes-editor" id="notesEditor" placeholder="üìù Area Catatan Digital - SD Kelas 3-6

üí° Tips Penggunaan:
‚Ä¢ Tulis catatan pelajaranmu di sini
‚Ä¢ Gunakan mode GAMBAR untuk menggambar rumus/diagram
‚Ä¢ Klik TANYAKAN untuk kirim ke ROBO Teacher
‚Ä¢ Semua catatan tersimpan otomatis di browser

üéØ Mata Pelajaran:
‚Ä¢ PKn: Pancasila, UUD 1945, NKRI, Bhinneka Tunggal Ika
‚Ä¢ Bahasa Indonesia: Membaca, menulis, berbicara, menyimak
‚Ä¢ Matematika: Operasi hitung, pecahan, bangun, pengukuran
‚Ä¢ IPAS: IPA (makhluk hidup, energi) + IPS (sejarah, geografi)
‚Ä¢ SBdP: Seni rupa, musik, tari, kerajinan
‚Ä¢ PJOK: Jasmani, kesehatan, olahraga

Siap belajar! üöÄ"></textarea>
                </div>

                <!-- Canvas Mode -->
                <div class="canvas-mode" id="canvasMode">
                    <div class="canvas-tools">
                        <button class="tool-btn active" onclick="setTool('pen')" title="Pena">‚úèÔ∏è</button>
                        <button class="tool-btn" onclick="setTool('eraser')" title="Penghapus">üßπ</button>
                        <div class="color-picker-wrapper">
                            <input type="color" class="color-picker" id="colorPicker" value="#f97316" onchange="setColor(this.value)">
                        </div>
                        <button class="tool-btn" onclick="clearCanvas()" title="Hapus Semua">üóëÔ∏è</button>
                        <button class="tool-btn" onclick="saveCanvasImage()" title="Simpan Gambar">üíæ</button>
                    </div>
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="cameraCanvas"></canvas>
        </div>
        <div class="camera-controls">
            <button class="btn-camera" onclick="takePhoto()" title="Ambil Foto"></button>
            <button class="btn-camera-cancel" onclick="closeCamera()">BATAL</button>
        </div>
    </div>

    <!-- Save Modal -->
    <div class="save-modal" id="saveModal">
        <div class="save-options">
            <h3>üíæ SIMPAN HASIL BELAJAR</h3>
            <div class="save-btn-group">
                <button class="btn-save-option" onclick="saveAsPDF()">
                    <span class="icon">üìÑ</span>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">SIMPAN SEBAGAI PDF</div>
                        <div style="font-size: 13px; color: #64748b;">Catatan dan gambar dalam satu file</div>
                    </div>
                </button>
                <button class="btn-save-option" onclick="saveAsJSON()">
                    <span class="icon">üìù</span>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">SIMPAN SEBAGAI JSON</div>
                        <div style="font-size: 13px; color: #64748b;">Data lengkap untuk dibuka lagi</div>
                    </div>
                </button>
                <button class="btn-save-option" onclick="saveAsImage()">
                    <span class="icon">üñºÔ∏è</span>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 4px;">SIMPAN SEBAGAI GAMBAR</div>
                        <div style="font-size: 13px; color: #64748b;">Screenshot halaman lengkap</div>
                    </div>
                </button>
            </div>
            <button class="btn-close-modal" onclick="closeSaveModal()">TUTUP</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="apikey-modal" id="apikeyModal">
        <div class="apikey-content">
            <h3>üîë Setting API Key Groq</h3>
            
            <div class="apikey-help">
                <strong>üöÄ GROQ - Ultra Fast AI Inference</strong><br><br>
                
                <strong>Keuntungan Groq:</strong><br>
                ‚Ä¢ ‚ö° Kecepatan super cepat (18x lebih cepat)<br>
                ‚Ä¢ üÜì Free tier tersedia (500K tokens/hari)<br>
                ‚Ä¢ üß† Model Llama 3.3 70B & Vision support<br>
                ‚Ä¢ üîí Open source models<br><br>
                
                <strong>Cara mendapatkan API Key:</strong><br>
                1. Buka <a href="https://console.groq.com" target="_blank">console.groq.com</a><br>
                2. Sign up gratis (no credit card)<br>
                3. Klik "Create API Key"<br>
                4. Copy dan paste di bawah<br><br>
                
                <strong>Format API Key:</strong> gsk_...
            </div>
            
            <input type="password" class="apikey-input" id="apiKeyInput" placeholder="Paste API Key Groq di sini (gsk_...)">
            
            <button class="btn-save-apikey" onclick="saveApiKey()">üíæ Simpan & Test API</button>
            
            <button class="btn-close-modal" onclick="closeApiKeyModal()" style="margin-top: 8px;">Batal</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div style="font-size: 24px;" id="toastIcon">‚úÖ</div>
        <div>
            <div style="font-weight: 700; color: #1e293b; margin-bottom: 4px; font-size: 14px;" id="toastTitle">BERHASIL</div>
            <div style="font-size: 13px; color: #64748b;" id="toastMessage">File telah disimpan</div>
        </div>
    </div>

    <script>
        // ==========================================
        // KONFIGURASI API - GROQ CLOUD
        // ==========================================
        
        // Default API Key (bisa diganti user via localStorage)
        let GROQ_API_KEY = localStorage.getItem('robo_groq_api_key') || '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';
        
        // Model Groq yang digunakan
        const GROQ_MODEL_TEXT = 'llama-3.3-70b-versatile';      // Untuk teks (fast & capable)
        const GROQ_MODEL_VISION = 'meta-llama/llama-4-scout-17b-16e-instruct';  // Untuk gambar (multimodal) [^17^]
        
        // Base URL API Groq (OpenAI compatible)
        const GROQ_BASE_URL = 'https://api.groq.com/openai/v1';

        // ==========================================
        // KURIKULUM SD KELAS 3-6 (MERDEKA)
        // ==========================================
        
        const CURRICULUM_DATA = {
            'pkn': {
                name: 'Pendidikan Pancasila dan Kewarganegaraan',
                icon: 'üèõÔ∏è',
                topics: {
                    3: 'Pancasila sebagai dasar negara, UUD 1945, Bhinneka Tunggal Ika, identitas nasional',
                    4: 'NKRI, keberagaman suku/budaya, gotong royong, nilai luhur budaya',
                    5: 'Hak dan kewajiban warga negara, demokrasi, keadilan, rule of law',
                    6: 'Globalisasi, digital citizenship, konservasi, persatuan bangsa'
                }
            },
            'bindonesia': {
                name: 'Bahasa Indonesia',
                icon: 'üáÆüá©',
                topics: {
                    3: 'Membaca pemahaman, menulis paragraf sederhana, puisi anak, cerita pendek',
                    4: 'Teks narasi, puisi rakyat, dongeng, menulis surat, berbicara di depan kelas',
                    5: 'Teks laporan hasil observasi, cerita fabel, pantun, pidato singkat',
                    6: 'Teks eksposisi, resensi buku, diskusi, debat, menulis karya ilmiah sederhana'
                }
            },
            'matematika': {
                name: 'Matematika',
                icon: 'üî¢',
                topics: {
                    3: 'Perkalian dan pembagian, pecahan sederhana, satuan panjang/berat/waktu, bangun datar',
                    4: 'Operasi hitung campuran, pecahan (penjumlahan/pengurangan), keliling luas, sudut',
                    5: 'Operasi hitung bilangan bulat, pecahan (perkalian/pembagian), skala, volume',
                    6: 'Bilangan bulat negatif, aritmatika sosial (bunga, diskon), statistik dasar, bangun ruang'
                }
            },
            'ipas': {
                name: 'Ilmu Pengetahuan Alam dan Sosial',
                icon: 'üåç',
                topics: {
                    3: 'Makhluk hidup (ciri, pertumbuhan, daur hidup), wujud benda, cuaca dan iklim',
                    4: 'Energi dan perubahannya, gaya dan gerak, ekosistem, peta dan atlas',
                    5: 'Bumi dan tata surya, batuan dan tanah, sejarah kerajaan Indonesia, ekonomi sederhana',
                    6: 'Bioteknologi, teknologi ramah lingkungan, perubahan sosial budaya, geografi Indonesia'
                }
            },
            'sbdp': {
                name: 'Seni Budaya dan Prakarya',
                icon: 'üé®',
                topics: {
                    3: 'Menggambar alam benda, mewarnai, origami, lagu anak-anak',
                    4: 'Melukis dengan cat air, musik ritmis, tari tradisional, kerajinan dari kertas',
                    5: 'Menggambar ilustrasi, musik melodis, tari kreasi, kerajinan dari limbah',
                    6: 'Desain grafis sederhana, komposisi musik, tari modern, kerajinan tekstil'
                }
            },
            'pjok': {
                name: 'Pendidikan Jasmani, Olahraga dan Kesehatan',
                icon: 'üèÉ',
                topics: {
                    3: 'Gerak lokomotor (berjalan, berlari, melompat), permainan sederhana, kebersihan diri',
                    4: 'Gerak non-lokomotor, permainan bola kecil (kasti), senam lantai, gizi seimbang',
                    5: 'Atletik dasar (lari, lompat, lempar), permainan bola besar (basket), P3K sederhana',
                    6: 'Renang gaya bebas, olahraga tradisional, kesehatan reproduksi dasar, first aid'
                }
            },
            'binggris': {
                name: 'Bahasa Inggris',
                icon: 'üá¨üáß',
                topics: {
                    3: 'Greetings, numbers 1-100, colors, family members, animals',
                    4: 'Daily activities, telling time, fruits and vegetables, simple present tense',
                    5: 'Hobbies, occupations, public places, simple past tense',
                    6: 'Vacation, transportation, health, future plans, descriptive text'
                }
            },
            'bdaerah': {
                name: 'Bahasa Daerah',
                icon: 'üó£Ô∏è',
                topics: {
                    3: 'Aksara daerah, kosakata dasar, lagu tradisional, dongeng daerah',
                    4: 'Percakapan sederhana, pantun/pepatah, cerita rakyat lokal',
                    5: 'Teks prosedur, pidato bahasa daerah, aksara tradisional',
                    6: 'Puisi daerah, drama tradisional, pelestarian budaya lisan'
                }
            }
        };

        // State aplikasi
        let currentMode = 'text';
        let currentTool = 'pen';
        let isDrawing = false;
        let recognition = null;
        let canvas, ctx;
        let chatOpen = true;
        let stream = null;
        let currentUpload = null;
        let questionCount = 0;
        let isProcessing = false;
        let apiReady = false;
        let useVisionModel = false; // Toggle untuk menggunakan model vision

        document.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            initVoice();
            loadNotes();
            updateGradeIndicator();
            updateSubjectInfo();
            updateCounterUI();
            
            // Cek API Key
            if (GROQ_API_KEY && GROQ_API_KEY !== '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') {
                testAPI();
            } else if (GROQ_API_KEY) {
                // API Key default dari kode, langsung test
                testAPI();
            } else {
                showApiKeyModal();
            }
            
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            checkResponsive();
            window.addEventListener('resize', checkResponsive);
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    resizeCanvas();
                    checkResponsive();
                }, 300);
            });
        });

        // ==========================================
        // API KEY MANAGEMENT
        // ==========================================

        function showApiKeyModal() {
            document.getElementById('apikeyModal').classList.add('active');
            if (GROQ_API_KEY) {
                document.getElementById('apiKeyInput').value = GROQ_API_KEY;
            }
        }

        function closeApiKeyModal() {
            document.getElementById('apikeyModal').classList.remove('active');
        }

        function saveApiKey() {
            const newKey = document.getElementById('apiKeyInput').value.trim();
            if (!newKey) {
                showToast('‚ùå', 'API KEY KOSONG', 'Masukkan API Key Groq terlebih dahulu!');
                return;
            }
            
            if (!newKey.startsWith('gsk_')) {
                showToast('‚ö†Ô∏è', 'FORMAT SALAH', 'API Key Groq harus diawali dengan "gsk_"');
                return;
            }
            
            GROQ_API_KEY = newKey;
            localStorage.setItem('robo_groq_api_key', newKey);
            closeApiKeyModal();
            
            // Test API baru
            testAPI();
        }

        // ==========================================
        // API TEST FUNCTION
        // ==========================================

        async function testAPI() {
            if (!GROQ_API_KEY) {
                updateApiStatus('warning', 'API Key belum di-set. Klik untuk setting.');
                return;
            }

            updateApiStatus('warning', 'Testing Groq API...');
            
            try {
                const response = await fetch(`${GROQ_BASE_URL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL_TEXT,
                        messages: [{ role: 'user', content: 'Hi' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    apiReady = true;
                    updateApiStatus('active', 'Groq AI siap digunakan! üöÄ');
                    showToast('‚úÖ', 'API TERHUBUNG', 'ROBO Teacher dengan Groq siap membantu!');
                    
                    // Update welcome message
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="message bot">
                            üëã Halo! Saya ROBO Teacher untuk SD Kelas 3-6 dengan <strong>Groq AI</strong>! üöÄ<br><br>
                            ‚ö° <strong>Kecepatan Super Cepat</strong> dengan teknologi Groq LPU!<br><br>
                            üéØ Mata Pelajaran:<br>
                            üèõÔ∏è <strong>PKn</strong> - Pancasila & Kewarganegaraan<br>
                            üáÆüá© <strong>Bahasa Indonesia</strong> - Literasi & Tata Bahasa<br>
                            üî¢ <strong>Matematika</strong> - Hitungan & Geometri<br>
                            üåç <strong>IPAS</strong> - Alam dan Sosial<br>
                            üé® <strong>SBdP</strong> - Seni dan Prakarya<br>
                            üèÉ <strong>PJOK</strong> - Olahraga & Kesehatan<br><br>
                            üí° <strong>Fitur Baru:</strong> Upload gambar untuk dianalisis (Vision AI)!<br>
                            Pilih mata pelajaran dan mulai bertanya! üöÄ
                        </div>
                    `;
                    
                    // Check if vision model is available
                    checkVisionAvailability();
                } else {
                    const error = await response.json();
                    const errorMsg = error.error?.message || 'Unknown error';
                    
                    if (errorMsg.includes('quota') || errorMsg.includes('rate limit')) {
                        updateApiStatus('error', 'Rate limit! Coba lagi nanti.');
                        showToast('‚ö†Ô∏è', 'RATE LIMIT', 'Free tier: 500K tokens/hari. Coba lagi nanti.');
                    } else if (errorMsg.includes('authentication') || errorMsg.includes('invalid')) {
                        updateApiStatus('error', 'API Key invalid! Klik untuk ganti.');
                        showToast('‚ùå', 'API KEY SALAH', 'Periksa kembali API Key Groq Anda.');
                    } else {
                        updateApiStatus('error', 'Error: ' + errorMsg.substring(0, 50));
                        showToast('‚ùå', 'API ERROR', errorMsg.substring(0, 100));
                    }
                }
            } catch (err) {
                updateApiStatus('error', 'Network Error');
                showToast('‚ùå', 'NETWORK ERROR', 'Cek koneksi internet Anda.');
            }
        }

        async function checkVisionAvailability() {
            // Cek apakah model vision tersedia
            try {
                const response = await fetch(`${GROQ_BASE_URL}/models`, {
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const hasVision = data.data.some(model => model.id.includes('vision') || model.id.includes('llama-4'));
                    if (hasVision) {
                        document.getElementById('visionBadge').style.display = 'inline-flex';
                        useVisionModel = true;
                    }
                }
            } catch (e) {
                console.log('Vision check failed:', e);
            }
        }

        function updateApiStatus(status, message) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = `api-status ${status}`;
            
            let icon = '‚ö†Ô∏è';
            if (status === 'active') icon = 'üöÄ';
            if (status === 'error') icon = '‚ùå';
            
            statusEl.innerHTML = `<span>${icon}</span><span>${message}</span>`;
        }

        // ==========================================
        // AI CHAT FUNCTIONALITY - GROQ API
        // ==========================================

        async function sendMessage() {
            if (!apiReady) {
                showToast('‚ö†Ô∏è', 'API BELUM SIAP', 'Klik tombol kuning di atas untuk setting API Key');
                showApiKeyModal();
                return;
            }

            if (isProcessing) {
                showToast('‚è≥', 'MOHON TUNGGU', 'Sedang memproses pertanyaan sebelumnya...');
                return;
            }

            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text && !currentUpload) return;

            // Validasi konten
            if (!validateContent(text)) {
                addMessage('Maaf, pertanyaan ini di luar topik SD Kelas 3-6 atau mengandung konten tidak sesuai. Yuk kita belajar pelajaran SD! üìö', 'bot');
                input.value = '';
                return;
            }

            isProcessing = true;

            // Tampilkan pesan user
            if (currentUpload) {
                addMessage(text || 'üì∑ GAMBAR:', 'user', currentUpload);
            } else {
                addMessage(text, 'user');
            }
            
            input.value = '';
            input.style.height = 'auto';
            showTyping();

            try {
                const response = await callGroqAPI(text, currentUpload);
                hideTyping();
                addMessage(response, 'bot');
                
                // Update counter
                questionCount++;
                updateCounterUI();
                
                // Clear upload after successful send
                if (currentUpload) {
                    removeUpload();
                }
                
            } catch (error) {
                hideTyping();
                console.error('API Error:', error);
                
                if (error.message.includes('rate limit') || error.message.includes('quota')) {
                    addMessage('‚ö†Ô∏è Maaf, rate limit tercapai (500K tokens/hari untuk free tier). Silakan tunggu beberapa saat atau upgrade ke paid tier di console.groq.com.', 'bot');
                    updateApiStatus('warning', 'Rate limit! Coba lagi nanti.');
                } else if (error.message.includes('authentication')) {
                    addMessage('‚ö†Ô∏è API Key tidak valid. Silakan periksa kembali API Key Groq Anda.', 'bot');
                    updateApiStatus('error', 'API Key invalid! Klik untuk ganti.');
                    apiReady = false;
                } else {
                    addMessage(`Maaf, terjadi kesalahan: ${error.message}. Coba lagi ya! ü§ñ`, 'bot');
                }
            } finally {
                isProcessing = false;
            }
        }

        async function callGroqAPI(userMessage, imageData = null) {
            const subject = document.getElementById('subjectSelect').value;
            const [subjectKey, grade] = subject.split('-');
            
            // Build system prompt
            const subjectData = CURRICULUM_DATA[subjectKey];
            const age = parseInt(grade) + 5;
            const topics = subjectData.topics[grade];
            
            const systemPrompt = `Anda adalah ROBO Teacher, asisten AI khusus untuk siswa SD Kelas ${grade} Indonesia.

IDENTITAS:
- Nama: ROBO Teacher
- Versi: 4.0 Groq Edition (Ultra Fast)
- Target: Siswa SD Kelas ${grade} (usia ${age} tahun)
- Mata Pelajaran: ${subjectData.name}

TOPIK YANG BOLEH DIAJarkan:
${topics}

ATURAN KETAT:
1. Hanya jawab pertanyaan terkait kurikulum SD Kelas ${grade} di atas
2. Gunakan bahasa Indonesia sederhana, ramah, sesuai usia ${age} tahun
3. Berikan contoh konkret dari kehidupan sehari-hari anak Indonesia
4. Gunakan emoji dan format yang menarik
5. Jika ditanya di luar topik di atas, tolak dengan sopan dan arahkan ke topik yang relevan
6. Jangan pernah memberikan konten: kekerasan, seks, narkoba, politik partisan, agama ekstrem, hoaks
7. Dorong siswa untuk berpikir kritis dan bertanya lebih lanjut
8. Maksimal 3-4 paragraf per jawaban, gunakan poin-poin

Jawab dengan hangat, mendidik, dan sesuai kurikulum!`;

            // Pilih model berdasarkan ada tidaknya gambar
            const model = (imageData && useVisionModel) ? GROQ_MODEL_VISION : GROQ_MODEL_TEXT;
            
            // Build messages array (OpenAI format)
            const messages = [
                {
                    role: 'system',
                    content: systemPrompt
                }
            ];

            // Handle image + text input
            if (imageData) {
                // Convert base64 to proper format
                const base64Data = imageData.split(',')[1];
                const mimeType = imageData.split(';')[0].split(':')[1] || 'image/jpeg';
                
                if (useVisionModel) {
                    // Vision model format (Llama 4 Scout)
                    messages.push({
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: userMessage || 'Jelaskan gambar ini sesuai pelajaran ' + subjectData.name
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: `data:${mimeType};base64,${base64Data}`
                                }
                            }
                        ]
                    });
                } else {
                    // Fallback untuk model non-vision: kirim sebagai text saja dengan info gambar
                    messages.push({
                        role: 'user',
                        content: (userMessage || 'Jelaskan gambar ini') + ' [User mengirimkan gambar, mohon analisis berdasarkan deskripsi visual yang mungkin]'
                    });
                }
            } else {
                messages.push({
                    role: 'user',
                    content: userMessage || 'Halo ROBO Teacher!'
                });
            }

            const requestBody = {
                model: model,
                messages: messages,
                temperature: 0.7,
                max_tokens: 2048,
                top_p: 0.9,
                stream: false
            };

            const response = await fetch(`${GROQ_BASE_URL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Groq API Error:', errorData);
                
                // Handle specific error codes [^6^]
                if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Free tier: 500K tokens/day');
                } else if (response.status === 401) {
                    throw new Error('Authentication failed. Invalid API Key.');
                } else if (response.status === 400) {
                    throw new Error('Bad request: ' + (errorData.error?.message || 'Invalid parameters'));
                }
                
                throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.choices || data.choices.length === 0) {
                throw new Error('Tidak ada respons dari AI');
            }

            return data.choices[0].message.content;
        }

        function validateContent(text) {
            if (!text) return true;
            
            const lowerText = text.toLowerCase();
            const forbiddenWords = [
                'sex', 'porn', 'narkoba', 'ganja', 'sabu', 'putaw',
                'bunuh', 'bunuh diri', 'senjata', 'pisau', 'tusuk'
            ];
            
            for (const word of forbiddenWords) {
                if (lowerText.includes(word)) {
                    return false;
                }
            }
            
            return true;
        }

        // ==========================================
        // UI FUNCTIONS
        // ==========================================

        function updateCounterUI() {
            document.getElementById('counterValue').textContent = questionCount;
            
            const percentage = Math.min((questionCount / 100) * 100, 100);
            document.getElementById('counterFill').style.width = `${percentage}%`;
            
            if (questionCount > 80) {
                document.getElementById('counterFill').classList.add('danger');
            } else if (questionCount > 50) {
                document.getElementById('counterFill').classList.add('warning');
            }
        }

        function toggleChat() {
            const sidebar = document.getElementById('chatSidebar');
            const openBtn = document.getElementById('btnOpenChat');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                sidebar.classList.remove('closed');
                openBtn.classList.remove('show');
                document.getElementById('chatBadge').style.display = 'none';
            } else {
                sidebar.classList.add('closed');
                openBtn.classList.add('show');
            }
        }

        function addMessage(text, sender, imageData = null) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            
            if (imageData) {
                div.innerHTML = `<div>${text}</div><img src="${imageData}" class="message-image" onclick="viewImage('${imageData}')">`;
            } else {
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/```([\s\S]*?)```/g, '<pre style="background:#f1f5f9;padding:8px;border-radius:6px;overflow-x:auto;"><code>$1</code></pre>')
                    .replace(/`([^`]+)`/g, '<code style="background:#f1f5f9;padding:2px 4px;border-radius:3px;">$1</code>')
                    .replace(/\n/g, '<br>');
                div.innerHTML = formattedText;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            if (!chatOpen && sender === 'bot') {
                document.getElementById('chatBadge').style.display = 'flex';
            }
        }

        function showTyping() {
            const container = document.getElementById('chatMessages');
            if (document.getElementById('typingIndicator')) return;
            
            const typing = document.createElement('div');
            typing.className = 'typing';
            typing.id = 'typingIndicator';
            typing.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator')?.remove();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function updateGradeIndicator() {
            const subject = document.getElementById('subjectSelect').value;
            const grade = subject.split('-')[1] || '3';
            document.getElementById('gradeIndicator').textContent = `KELAS ${grade}`;
        }

        function updateSubjectInfo() {
            const subject = document.getElementById('subjectSelect').value;
            const [subjectKey, grade] = subject.split('-');
            const subjectData = CURRICULUM_DATA[subjectKey];
            
            const infoDiv = document.getElementById('subjectInfo');
            if (subjectData && infoDiv) {
                const topics = subjectData.topics[grade];
                infoDiv.innerHTML = `<strong>${subjectData.icon} ${subjectData.name} Kelas ${grade}:</strong> ${topics}`;
            }
        }

        function changeSubject(subject) {
            saveNotes();
            loadNotes();
            updateGradeIndicator();
            updateSubjectInfo();
            
            const subjectKey = subject.split('-')[0];
            const grade = subject.split('-')[1];
            const subjectData = CURRICULUM_DATA[subjectKey];
            
            if (subjectData) {
                addMessage(`üìö BERALIH KE: ${subjectData.name} Kelas ${grade}`, 'bot');
            }
        }

        // ==========================================
        // FILE UPLOAD & CAMERA
        // ==========================================

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 4 * 1024 * 1024) {
                showToast('‚ö†Ô∏è', 'UKURAN TERLALU BESAR', 'Maksimal 4MB untuk Groq Vision!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentUpload = e.target.result;
                showUploadPreview(currentUpload);
                showToast('üì∑', 'GAMBER SIAP', 'Gambar akan dianalisis dengan AI Vision!');
            };
            reader.readAsDataURL(file);
        }

        function showUploadPreview(imageData) {
            const preview = document.getElementById('uploadPreview');
            const img = document.getElementById('previewImage');
            img.src = imageData;
            preview.classList.add('active');
        }

        function removeUpload() {
            currentUpload = null;
            document.getElementById('uploadPreview').classList.remove('active');
            document.getElementById('fileInput').value = '';
        }

        function openCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then((s) => {
                    stream = s;
                    video.srcObject = stream;
                    modal.classList.add('active');
                })
                .catch((err) => {
                    showToast('‚ùå', 'ERROR KAMERA', err.message);
                });
        }

        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const cameraCanvas = document.getElementById('cameraCanvas');
            const ctx = cameraCanvas.getContext('2d');
            
            cameraCanvas.width = video.videoWidth;
            cameraCanvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            currentUpload = cameraCanvas.toDataURL('image/jpeg', 0.8);
            showUploadPreview(currentUpload);
            closeCamera();
            
            showToast('üì∑', 'BERHASIL', 'Foto diambil! Klik kirim untuk mengirim ke AI Vision.');
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('active');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function viewImage(src) {
            window.open(src, '_blank');
        }

        // ==========================================
        // VOICE INPUT
        // ==========================================

        function initVoice() {
            if (!('webkitSpeechRecognition' in window)) return;
            
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.continuous = false;
            
            recognition.onresult = (e) => {
                document.getElementById('messageInput').value = e.results[0][0].transcript;
                toggleVoice();
            };
            
            recognition.onend = () => {
                document.getElementById('voiceBtn').classList.remove('recording');
            };
            
            recognition.onerror = (e) => {
                console.error('Voice recognition error:', e);
                document.getElementById('voiceBtn').classList.remove('recording');
                showToast('‚ùå', 'VOICE ERROR', 'Coba lagi ya!');
            };
        }

        function toggleVoice() {
            if (!recognition) {
                showToast('‚ùå', 'BROWSER TIDAK MENDUKUNG', 'Gunakan Chrome ya!');
                return;
            }
            
            const btn = document.getElementById('voiceBtn');
            if (btn.classList.contains('recording')) {
                recognition.stop();
                btn.classList.remove('recording');
            } else {
                recognition.start();
                btn.classList.add('recording');
                showToast('üé§', 'MENDENGARKAN...', 'Bicara sekarang!');
            }
        }

        // ==========================================
        // CANVAS FUNCTIONS
        // ==========================================

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDraw);
            canvas.addEventListener('touchcancel', stopDraw);
        }

        function resizeCanvas() {
            const parent = canvas.parentElement;
            if (!parent) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            if (canvas.width > 0 && canvas.height > 0) {
                tempCtx.drawImage(canvas, 0, 0);
            }
            
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (tempCanvas.width > 0 && tempCanvas.height > 0) {
                ctx.drawImage(tempCanvas, 0, 0);
            }
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const coords = getCoordinates(e);
            
            ctx.lineWidth = currentTool === 'eraser' ? 20 : 2;
            ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : document.getElementById('colorPicker').value;
            
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
            ctx.beginPath();
        }

        function handleTouchStart(e) {
            e.preventDefault();
            startDraw(e);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            draw(e);
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setColor(color) {
            currentTool = 'pen';
        }

        function clearCanvas() {
            if (confirm('Hapus semua gambar?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function saveCanvasImage() {
            const link = document.createElement('a');
            link.download = `robo-gambar-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showToast('üíæ', 'BERHASIL', 'Gambar disimpan!');
        }

        // ==========================================
        // SAVE & EXPORT
        // ==========================================

        async function askFromContent() {
            if (!apiReady) {
                showToast('‚ö†Ô∏è', 'API BELUM SIAP', 'Setting API Key terlebih dahulu');
                showApiKeyModal();
                return;
            }

            if (isProcessing) {
                showToast('‚è≥', 'MOHON TUNGGU', 'Sedang memproses...');
                return;
            }

            let question = '';
            
            if (currentMode === 'text') {
                question = document.getElementById('notesEditor').value.trim();
                if (!question) {
                    showToast('‚úèÔ∏è', 'AREA KOSONG', 'Tulis pertanyaan terlebih dahulu!');
                    document.getElementById('notesEditor').focus();
                    return;
                }
            } else {
                question = "[GAMBAR KANVAS] Bisakah ROBO Teacher menjelaskan gambar ini sesuai pelajaran yang sedang dipelajari?";
                const canvasData = canvas.toDataURL('image/png');
                
                if (!chatOpen) toggleChat();
                
                addMessage(question, 'user', canvasData);
                showTyping();
                isProcessing = true;
                
                try {
                    const response = await callGroqAPI(question, canvasData);
                    hideTyping();
                    addMessage(response, 'bot');
                    questionCount++;
                    updateCounterUI();
                } catch (error) {
                    hideTyping();
                    addMessage(`Maaf, error: ${error.message}`, 'bot');
                } finally {
                    isProcessing = false;
                }
                return;
            }
            
            if (!chatOpen) toggleChat();
            
            addMessage(question, 'user');
            showTyping();
            isProcessing = true;
            
            try {
                const response = await callGroqAPI(question);
                hideTyping();
                addMessage(response, 'bot');
                questionCount++;
                updateCounterUI();
            } catch (error) {
                hideTyping();
                addMessage(`Maaf, error: ${error.message}`, 'bot');
            } finally {
                isProcessing = false;
            }
        }

        function showSaveOptions() {
            document.getElementById('saveModal').classList.add('active');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
        }

        async function saveAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const subject = document.getElementById('subjectSelect');
            const subjectName = subject.options[subject.selectedIndex].text;
            
            pdf.setFontSize(22);
            pdf.text(`ROBO TEACHER SD - ${subjectName}`, 20, 25);
            pdf.setFontSize(12);
            pdf.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 20, 35);
            pdf.text(`Total Pertanyaan: ${questionCount}`, 20, 42);
            pdf.text(`Powered by: Groq AI`, 20, 49);
            
            const notes = document.getElementById('notesEditor').value;
            if (notes) {
                pdf.setFontSize(11);
                const splitNotes = pdf.splitTextToSize(notes, 170);
                pdf.text(splitNotes, 20, 60);
            }
            
            if (currentMode === 'canvas') {
                const canvasData = canvas.toDataURL('image/png');
                pdf.addPage();
                pdf.text('GAMBAR:', 20, 20);
                pdf.addImage(canvasData, 'PNG', 20, 30, 170, 100);
            }
            
            pdf.save(`ROBO-SD-Groq-${subjectName}-${Date.now()}.pdf`);
            closeSaveModal();
            showToast('üìÑ', 'PDF TERSIMPAN', 'File berhasil diunduh!');
        }

        function saveAsJSON() {
            const subject = document.getElementById('subjectSelect').value;
            const [subjectKey, grade] = subject.split('-');
            
            const data = {
                roboVersion: "4.0-Groq-Edition",
                tanggal: new Date().toISOString(),
                mataPelajaran: subject,
                namaPelajaran: CURRICULUM_DATA[subjectKey]?.name || subject,
                kelas: grade,
                catatan: document.getElementById('notesEditor').value,
                canvas: currentMode === 'canvas' ? canvas.toDataURL() : null,
                statistik: {
                    totalPertanyaan: questionCount,
                    api: 'Groq Cloud',
                    model: GROQ_MODEL_TEXT
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ROBO-SD-GROQ-DATA-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeSaveModal();
            showToast('üìù', 'JSON TERSIMPAN', 'Data lengkap tersimpan!');
        }

        async function saveAsImage() {
            const workspace = document.getElementById('workspace');
            
            try {
                const canvasElement = await html2canvas(workspace, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    allowTaint: true
                });
                
                const link = document.createElement('a');
                link.download = `ROBO-SD-SCREENSHOT-${Date.now()}.png`;
                link.href = canvasElement.toDataURL();
                link.click();
                
                closeSaveModal();
                showToast('üñºÔ∏è', 'SCREENSHOT TERSIMPAN', 'Gambar halaman berhasil diunduh!');
            } catch (err) {
                showToast('‚ùå', 'GAGAL', 'Tidak dapat mengambil screenshot');
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('textMode').classList.toggle('active', mode === 'text');
            document.getElementById('canvasMode').classList.toggle('active', mode === 'canvas');
            
            if (mode === 'canvas') {
                setTimeout(resizeCanvas, 100);
            }
        }

        function saveNotes() {
            const subject = document.getElementById('subjectSelect').value;
            localStorage.setItem(`robo_notes_${subject}`, document.getElementById('notesEditor').value);
        }

        function loadNotes() {
            const subject = document.getElementById('subjectSelect').value;
            document.getElementById('notesEditor').value = localStorage.getItem(`robo_notes_${subject}`) || '';
        }

        function showToast(icon, title, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function checkResponsive() {
            const width = window.innerWidth;
            if (width <= 767 && chatOpen) {
                toggleChat();
            }
        }

        // Auto-save notes
        let saveTimeout;
        document.getElementById('notesEditor').addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveNotes, 1000);
        });

        // Close modals on click outside
        document.getElementById('saveModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeSaveModal();
        });
        document.getElementById('apikeyModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeApiKeyModal();
        });

        // Escape key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSaveModal();
                closeCamera();
                closeApiKeyModal();
            }
        });
    </script>
</body>
</html>
